<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>XALUXA AGENCY | Professional Trading</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            screens: { 'xs': '480px' },
            colors: {
              discord: { blue: '#5865F2', gray: '#36393f' },
              gold: { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' },
              dark: { 950: '#020617', 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
              light: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1' }
            },
            animation: {
              'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'fade-in': 'fadeIn 0.5s ease-out',
              'slide-up': 'slideUp 0.6s ease-out',
              'slide-up-fade': 'slideUpFade 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)',
              'scale-in': 'scaleIn 0.4s ease-out',
              'float': 'float 6s ease-in-out infinite',
              'slide-in-right': 'slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
              'spin-slow': 'spin 3s linear infinite',
            },
            keyframes: {
                fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                slideUp: { '0%': { transform: 'translateY(30px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                slideUpFade: { '0%': { transform: 'translateY(40px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                scaleIn: { '0%': { transform: 'scale(0.92)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                slideInRight: { '0%': { transform: 'translateX(100%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } }
            }
          },
        },
      }
    </script>

    <!-- React & Recharts -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <style>
      body { transition: background-color 0.5s ease, color 0.5s ease; overflow-x: hidden; }
      .transition-theme { transition: all 500ms cubic-bezier(0.4, 0, 0.2, 1); }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
      .blur-content { filter: blur(4px); user-select: none; pointer-events: none; }
      .garland-container { position: absolute; top: 0; left: 0; width: 100%; height: 40px; z-index: 5; overflow: hidden; pointer-events: none; display: flex; justify-content: space-around; }
      .garland-bulb { width: 12px; height: 12px; border-radius: 50%; margin-top: -6px; animation: swing 3s ease-in-out infinite; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
      .garland-bulb:nth-child(odd) { background-color: #ef4444; animation-duration: 3.5s; }
      .garland-bulb:nth-child(even) { background-color: #10b981; animation-duration: 2.5s; }
      .garland-bulb:nth-child(3n) { background-color: #f59e0b; }
      @keyframes swing { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(3px) rotate(5deg); } }
      .btn-hover { transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
      .btn-hover:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 10px 20px -10px rgba(0,0,0,0.3); filter: brightness(1.1); }
      .btn-hover:active { transform: translateY(0) scale(0.98); }
      .reveal { opacity: 0; transform: translateY(40px); transition: all 1s cubic-bezier(0.5, 0, 0, 1); }
      .reveal.active { opacity: 1; transform: translateY(0); }
      .reveal.delay-100 { transition-delay: 0.1s; }
      .reveal.delay-200 { transition-delay: 0.2s; }
      .reveal.delay-300 { transition-delay: 0.3s; }
      .animate-float { animation: float 6s ease-in-out infinite; }
      .premium-gradient { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- GLOBALS & IMPORTS ---
        const { useState, useEffect, createContext, useContext, useMemo, useRef } = React;
        const RechartsObj = window.Recharts;
        const { BarChart, Bar, Cell, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Legend, ReferenceLine } = RechartsObj || {};

        // --- HOOKS ---
        const useMediaQuery = (query) => {
            const [matches, setMatches] = useState(false);
            useEffect(() => {
                const media = window.matchMedia(query);
                if (media.matches !== matches) setMatches(media.matches);
                const listener = () => setMatches(media.matches);
                window.addEventListener("resize", listener); 
                return () => window.removeEventListener("resize", listener);
            }, [matches, query]);
            return matches;
        };

        const useScrollReveal = (deps = []) => {
            useEffect(() => {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('active'); observer.unobserve(entry.target); }});
                }, { threshold: 0.1, rootMargin: "0px 0px -50px 0px" });
                const elements = document.querySelectorAll('.reveal');
                elements.forEach(el => observer.observe(el));
                return () => observer.disconnect();
            }, deps);
        };

        // --- ICONS ---
        const Icon = ({ size = 24, className = "", children, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const Activity = (p) => (<Icon {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></Icon>);
        const TrendingUp = (p) => (<Icon {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></Icon>);
        const DollarSign = (p) => (<Icon {...p}><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></Icon>);
        const LogOut = (p) => (<Icon {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></Icon>);
        const Send = (p) => (<Icon {...p}><line x1="22" x2="11" y1="2" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></Icon>);
        const PlusCircle = (p) => (<Icon {...p}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="16" /><line x1="8" x2="16" y1="12" y2="12" /></Icon>);
        const Trophy = (p) => (<Icon {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M12 15a7 7 0 0 0 7-7c0-2-4-2-4-2H9c0 0-4 0-4 2a7 7 0 0 0 7 7Z" /><path d="M12 15v7" /></Icon>);
        const Coins = (p) => (<Icon {...p}><circle cx="8" cy="8" r="6" /><path d="M18.09 10.37A6 6 0 1 1 10.34 18" /><path d="M7 6h1v4" /><path d="m16.71 13.88.7.71-2.82 2.82" /></Icon>);
        const Sun = (p) => (<Icon {...p}><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></Icon>);
        const Moon = (p) => (<Icon {...p}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" /></Icon>);
        const X = (p) => (<Icon {...p}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" x2="6" y1="6" x2="18" y2="18" /></Icon>);
        const Briefcase = (p) => (<Icon {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></Icon>);
        const Layers = (p) => (<Icon {...p}><polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 17 12 22 22 17" /><polyline points="2 12 12 17 22 12" /></Icon>);
        const Newspaper = (p) => (<Icon {...p}><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8V6Z"/></Icon>);
        const Clock = (p) => (<Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>);
        const Lock = (p) => (<Icon {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></Icon>);
        const ShieldAlert = (p) => (<Icon {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></Icon>);
        const ShieldCheck = (p) => (<Icon {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /><path d="m9 12 2 2 4-4" /></Icon>);
        const Users = (p) => (<Icon {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>);
        const CheckCircle = (p) => (<Icon {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>);
        const LinkIcon = (p) => (<Icon {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></Icon>);
        const Crown = (p) => (<Icon {...p}><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></Icon>);
        const Info = (p) => (<Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></Icon>);
        const Gift = (p) => (<Icon {...p}><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></Icon>);
        const FileText = (p) => (<Icon {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>);
        const Plus = (p) => (<Icon {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>);
        const Minus = (p) => (<Icon {...p}><line x1="5" y1="12" x2="19" y2="12"/></Icon>);
        const Snowflake = (p) => (<Icon {...p}><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/><path d="m20 16-4-4 4-4"/><path d="m4 8 4 4-4 4"/><path d="m16 4-4 4-4-4"/><path d="m8 20 4-4 4 4"/></Icon>);
        const Wallet = (p) => (<Icon {...p}><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></Icon>);
        const Edit2 = (p) => (<Icon {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>);
        const Trash = (p) => (<Icon {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></Icon>);
        const Calendar = (p) => (<Icon {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></Icon>);
        const Gamepad = (p) => (<Icon {...p}><line x1="6" x2="10" y1="12" y2="12" /><line x1="8" x2="8" y1="10" y2="14" /><line x1="15" x2="15.01" y1="13" y2="13" /><line x1="18" x2="18.01" y1="11" y2="11" /><rect x="2" y="6" width="20" height="12" rx="2" /></Icon>);

        // --- CONSTANTS ---
        const CryptoSymbol = { ATERIS: 'ATERIS', BALIEM: 'BALIEM', BASTRUM: 'BASTRUM', UDC: 'UDC' };
        
        const FEES = {
            BUY: 0.02,
            SELL: 0.02,
            TRANSFER: 0.01
        };

        const INITIAL_MARKET_DATA = [
            { symbol: CryptoSymbol.ATERIS, name: 'Ateris', price: 72500, change24h: 2.5, history: [], color: '#f59e0b', active: true },
            { symbol: CryptoSymbol.BALIEM, name: 'Baliem', price: 24000, change24h: -1.2, history: [], color: '#3b82f6', active: true },
            { symbol: CryptoSymbol.BASTRUM, name: 'Bastrum', price: 2500, change24h: 15.4, history: [], color: '#10b981', active: true },
            { symbol: CryptoSymbol.UDC, name: 'UDC', price: 1, change24h: 0, history: [], color: '#94a3b8', active: true },
        ];
        
        const SPECIAL_CODES = {
            CRYPTO10: 'SYSTEM_CRYPTO10'
        };

        // --- ENGINE ---
        const simulateMarketUpdate = (currentMarket) => {
            return currentMarket.map((asset) => {
                if (asset.symbol === CryptoSymbol.UDC || !asset.active) return asset;
                
                const lastPoint = asset.history[asset.history.length - 1];
                const open = lastPoint ? lastPoint.close : asset.price;
                
                const change = (Math.random() - 0.5) * 0.02 * open;
                const close = Math.max(0.1, open + change);
                
                const high = Math.max(open, close) + Math.random() * 0.005 * open;
                const low = Math.min(open, close) - Math.random() * 0.005 * open;
                
                const newCandle = { 
                    time: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit', second:'2-digit'}), 
                    open, close, high, low,
                    price: close 
                };
                
                const newHistory = [...asset.history, newCandle];
                if (newHistory.length > 40) newHistory.shift();
                
                return { 
                    ...asset, 
                    price: close, 
                    history: newHistory, 
                    change24h: asset.change24h + (Math.random() - 0.5) * 0.5 
                };
            });
        };

        const generateReferralCode = (username) => {
            const base = username.replace(/[^a-zA-Z0-9]/g, '').substring(0, 4).toUpperCase();
            const suffix = Math.floor(1000 + Math.random() * 9000); 
            return `${base}${suffix}`;
        };

        const generateInternalId = () => {
            const p1 = Math.floor(1000 + Math.random() * 9000);
            const p2 = Math.floor(1000 + Math.random() * 9000);
            return `XID-${p1}-${p2}`;
        };

        const isUserPremium = (u) => {
            if (!u || !u.premium || !u.premium.active) return false;
            if (new Date(u.premium.expiresAt) < new Date()) return false;
            return true;
        };
        
        const SnowEffect = ({ enabled }) => {
            const canvasRef = useRef(null);
            
            useEffect(() => {
                if (!enabled) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let width = window.innerWidth;
                let height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;

                const particles = [];
                const particleCount = 100;
                for (let i = 0; i < particleCount; i++) {
                    particles.push({ x: Math.random() * width, y: Math.random() * height, radius: Math.random() * 3 + 1, density: Math.random() * particleCount, speed: Math.random() * 1 + 0.5 });
                }

                let animationFrameId;
                const draw = () => {
                    ctx.clearRect(0, 0, width, height);
                    ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                    ctx.beginPath();
                    for (let i = 0; i < particleCount; i++) {
                        const p = particles[i];
                        ctx.moveTo(p.x, p.y);
                        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2, true);
                    }
                    ctx.fill();
                    update();
                    animationFrameId = requestAnimationFrame(draw);
                };
                const update = () => {
                    for (let i = 0; i < particleCount; i++) {
                        const p = particles[i];
                        p.y += p.speed;
                        p.x += Math.sin(p.density);
                        if (p.y > height) { particles[i] = { x: Math.random() * width, y: -10, radius: p.radius, density: p.density, speed: p.speed }; }
                    }
                };
                draw();
                const handleResize = () => { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; };
                window.addEventListener('resize', handleResize);
                return () => { cancelAnimationFrame(animationFrameId); window.removeEventListener('resize', handleResize); };
            }, [enabled]);
            if (!enabled) return null;
            return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-[1]" />;
        };

        // --- CONTEXT ---
        const MarketContext = createContext(undefined);

        const MarketProvider = ({ children }) => {
            const [market, setMarket] = useState(() => { const saved = localStorage.getItem('xaluxa_market'); return saved ? JSON.parse(saved) : INITIAL_MARKET_DATA; });
            const [user, setUser] = useState(null); 
            const [allUsers, setAllUsers] = useState([]); 
            const [transactions, setTransactions] = useState([]);
            const [orders, setOrders] = useState([]); 
            const [activePage, setActivePage] = useState('HOME');
            const [theme, setTheme] = useState('dark');
            const [isLoading, setIsLoading] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [isProfileOpen, setProfileOpen] = useState(false);
            const [adminLogs, setAdminLogs] = useState([]);
            const [uiNotifications, setUiNotifications] = useState([]);
            const [isChristmas, setIsChristmas] = useState(() => { const saved = localStorage.getItem('xaluxa_christmas'); return saved !== 'false'; });

            const toggleChristmasMode = () => { setIsChristmas(prev => { const newVal = !prev; localStorage.setItem('xaluxa_christmas', newVal); return newVal; }); };
            
            const marketRef = useRef(market);
            const userRef = useRef(user);
            const ordersRef = useRef(orders);

            useEffect(() => { marketRef.current = market; localStorage.setItem('xaluxa_market', JSON.stringify(market)); }, [market]);
            useEffect(() => { userRef.current = user; }, [user]);
            useEffect(() => { ordersRef.current = orders; }, [orders]);

            const CLIENT_IP = useMemo(() => {
                let ip = localStorage.getItem('xaluxa_client_ip');
                if (!ip) { ip = 'ip_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15); localStorage.setItem('xaluxa_client_ip', ip); }
                return ip;
            }, []);

            useEffect(() => { const savedTheme = localStorage.getItem('xaluxa_theme') || 'dark'; setTheme(savedTheme); document.documentElement.className = savedTheme; }, []);
            const toggleTheme = () => { const newTheme = theme === 'dark' ? 'light' : 'dark'; setTheme(newTheme); localStorage.setItem('xaluxa_theme', newTheme); document.documentElement.className = newTheme; };

            const toggleProfile = (state) => setProfileOpen(state !== undefined ? state : !isProfileOpen);

            const addUiNotification = (note) => { const id = note.id || Date.now(); setUiNotifications(prev => [...prev, { ...note, id }]); setTimeout(() => { setUiNotifications(prev => prev.filter(n => n.id !== id)); }, 5000); };

            useEffect(() => {
                if(!user) return;
                const interval = setInterval(() => {
                     const raw = localStorage.getItem('xaluxa_db');
                     if(!raw) return;
                     const db = JSON.parse(raw);
                     const me = db.find(u => u.id === user.id);
                     if(me && me.pending_notifications && me.pending_notifications.length > 0) {
                         const newNotifs = me.pending_notifications;
                         newNotifs.forEach(n => { if(n.type === 'MONEY_IN') addUiNotification(n); });
                         me.pending_notifications = [];
                         localStorage.setItem('xaluxa_db', JSON.stringify(db));
                         setAllUsers(db);
                         setUser(current => ({ ...current, wallet: me.wallet, pending_notifications: [] }));
                         localStorage.setItem('xaluxa_user', JSON.stringify({ ...user, wallet: me.wallet, pending_notifications: [] }));
                     }
                }, 1000); 
                return () => clearInterval(interval);
            }, [user]);

            useEffect(() => {
                setMarket(prev => prev.map(asset => {
                    const history = [];
                    let p = asset.price;
                    for(let i=0; i<30; i++) { 
                        const open = p;
                        const change = (Math.random() * 0.04 - 0.02) * open;
                        const close = Math.max(0.1, open + change);
                        const high = Math.max(open, close) + Math.random() * 0.005 * open;
                        const low = Math.min(open, close) - Math.random() * 0.005 * open;
                        p = close;
                        history.push({ time: i.toString(), open, close, high, low, price: close }); 
                    }
                    return { ...asset, history };
                }));
                const savedDb = localStorage.getItem('xaluxa_db');
                if (savedDb) setAllUsers(JSON.parse(savedDb));
                const savedLogs = localStorage.getItem('xaluxa_admin_logs');
                if (savedLogs) setAdminLogs(JSON.parse(savedLogs));
                setTransactions([
                    { type: 'BUY', symbol: 'ATERIS', qty: 0.012, price: 71000, time: '10:23' },
                    { type: 'SELL', symbol: 'BASTRUM', qty: 5.4, price: 2300, time: '09:45' },
                ]);
            }, []);

            useEffect(() => { if(allUsers.length > 0) localStorage.setItem('xaluxa_db', JSON.stringify(allUsers)); }, [allUsers]);

            useEffect(() => {
                const hash = window.location.hash;
                const savedUser = localStorage.getItem('xaluxa_user');
                if (savedUser) { const u = JSON.parse(savedUser); setUser(u); setOrders(u.activeOrders || []); }

                if (hash && hash.includes('access_token')) {
                    setIsLoading(true);
                    const fragment = new URLSearchParams(hash.slice(1));
                    const accessToken = fragment.get('access_token');
                    if (accessToken) {
                        fetch('https://discord.com/api/users/@me', { headers: { authorization: `Bearer ${accessToken}` } })
                        .then(r => r.json())
                        .then(data => {
                            if(data.id) {
                                handleUserLogin({
                                    id: data.id,
                                    discord: {
                                        id: data.id,
                                        username: `${data.username}#${data.discriminator || '0000'}`,
                                        avatar: data.avatar ? `https://cdn.discordapp.com/avatars/${data.id}/${data.avatar}.jpg` : 'https://cdn.discordapp.com/embed/avatars/0.png'
                                    },
                                    steam: null,
                                    wallet: { cash: 0, assets: { [CryptoSymbol.ATERIS]: 0, [CryptoSymbol.BALIEM]: 0, [CryptoSymbol.BASTRUM]: 0, [CryptoSymbol.UDC]: 0 } }
                                });
                                setActivePage('HOME');
                            }
                        }).catch(e => console.error(e)).finally(() => { setIsLoading(false); window.history.replaceState({}, document.title, window.location.pathname); });
                    }
                }
            }, []);

            const handleUserLogin = (userData) => {
                const now = new Date().toISOString();
                setUser(prev => {
                    const existingUserInDb = allUsers.find(u => u.id === userData.id);
                    let userState;
                    if (existingUserInDb) {
                        if (!existingUserInDb.internalId) existingUserInDb.internalId = generateInternalId();
                        userState = { ...existingUserInDb, ...userData, lastLogin: now, ip: CLIENT_IP }; 
                        if(existingUserInDb.activeOrders) setOrders(existingUserInDb.activeOrders);
                        if(!userState.premium) userState.premium = { active: false, expiresAt: null };
                    } else {
                        userState = { 
                            ...userData, 
                            internalId: generateInternalId(),
                            joinedAt: now, lastLogin: now, ip: CLIENT_IP, 
                            referralCode: null, referredBy: null, referralWallet: 0, totalReferralEarnings: 0,
                            activeOrders: [], pending_notifications: [],
                            premium: { active: false, expiresAt: null }
                        };
                    }
                    setAllUsers(currentDb => {
                        const idx = currentDb.findIndex(u => u.id === userState.id);
                        if(idx >= 0) { const updatedDb = [...currentDb]; updatedDb[idx] = userState; return updatedDb; } else { return [...currentDb, userState]; }
                    });
                    localStorage.setItem('xaluxa_user', JSON.stringify(userState));
                    return userState;
                });
            };

            const generateMyReferralCode = () => {
                if (!user || user.referralCode) return { s: true }; 
                const ipUsage = allUsers.find(u => u.ip === CLIENT_IP && u.referralCode && u.id !== user.id);
                if (ipUsage) return { s: false, m: "Cette adresse IP a déjà généré un code." };
                const newCode = generateReferralCode(user.discord.username);
                if (allUsers.find(u => u.referralCode === newCode)) return { s: false, m: "Erreur. Réessayez." };
                const updatedUser = { ...user, referralCode: newCode };
                setUser(updatedUser); updateUserInDb(updatedUser); localStorage.setItem('xaluxa_user', JSON.stringify(updatedUser));
                return { s: true, m: "Code généré avec succès." };
            };

            const applyReferralCode = (code) => {
                if (!user) return { s: false, m: "Non connecté" };
                if (user.referredBy) return { s: false, m: "Vous avez déjà un parrain." };
                const cleanCode = code.trim().toUpperCase();
                if (cleanCode === 'CRYPTO10') {
                    const updatedUser = { ...user, referredBy: SPECIAL_CODES.CRYPTO10 }; 
                    setUser(updatedUser); updateUserInDb(updatedUser); localStorage.setItem('xaluxa_user', JSON.stringify(updatedUser));
                    return { s: true, m: "Code Promo activé !" };
                }
                const referrer = allUsers.find(u => u.referralCode === cleanCode);
                if (!referrer) return { s: false, m: "Code introuvable." };
                if (referrer.id === user.id) return { s: false, m: "Auto-parrainage interdit." };
                const BONUS_AMOUNT = 100;
                const updatedUser = { ...user, referredBy: referrer.id, wallet: { ...user.wallet, cash: user.wallet.cash + BONUS_AMOUNT } };
                setUser(updatedUser); updateUserInDb(updatedUser); localStorage.setItem('xaluxa_user', JSON.stringify(updatedUser));
                return { s: true, m: `Parrainé par ${referrer.discord.username}. Bonus ajouté !` };
            };

            const claimReferralEarnings = () => {
                if (!user || user.referralWallet <= 0) return { s: false, m: "Rien à récupérer." };
                const amount = user.referralWallet;
                const updatedUser = { ...user, wallet: { ...user.wallet, cash: user.wallet.cash + amount }, referralWallet: 0 };
                setUser(updatedUser); updateUserInDb(updatedUser); localStorage.setItem('xaluxa_user', JSON.stringify(updatedUser));
                return { s: true, m: `$${amount.toFixed(2)} transférés.` };
            };

            const updateUserInDb = (updatedUserObj) => { setAllUsers(prev => prev.map(u => u.id === updatedUserObj.id ? updatedUserObj : u)); };

            const manageUserPremium = (targetUserId, months) => {
                if (!isAdmin) return { s: false, m: "Non autorisé" };
                const targetUser = allUsers.find(u => u.id === targetUserId);
                if (!targetUser) return { s: false, m: "Utilisateur introuvable" };
                
                const now = new Date();
                const currentExpiry = (targetUser.premium && targetUser.premium.active && targetUser.premium.expiresAt) 
                    ? new Date(targetUser.premium.expiresAt) 
                    : now;
                
                // If currently expired, start from now, else add to existing expiry
                const startDate = currentExpiry < now ? now : currentExpiry;
                const newExpiry = new Date(startDate);
                newExpiry.setMonth(newExpiry.getMonth() + parseInt(months));
                
                const updatedUser = { 
                    ...targetUser, 
                    premium: { 
                        active: true, 
                        expiresAt: newExpiry.toISOString() 
                    } 
                };
                
                updateUserInDb(updatedUser);
                if (user && user.id === targetUserId) { setUser(updatedUser); localStorage.setItem('xaluxa_user', JSON.stringify(updatedUser)); }
                
                const logEntry = { id: Date.now(), adminId: 'Admin', targetUserId: targetUser.id, targetUsername: targetUser.discord?.username || 'Unknown', action: 'PREMIUM_ADD', amount: months + ' Mois', balanceBefore: 0, balanceAfter: 0, reason: 'Admin Gift', timestamp: new Date().toLocaleString('fr-FR'), ip: '127.0.0.1' };
                const newLogs = [logEntry, ...adminLogs];
                setAdminLogs(newLogs);
                localStorage.setItem('xaluxa_admin_logs', JSON.stringify(newLogs));
                
                return { s: true, m: `Premium activé pour ${months} mois.` };
            };

            const manageUserMoney = (targetUserId, amount, type, reason) => {
                if (!isAdmin) return { s: false, m: "Non autorisé" };
                const targetUser = allUsers.find(u => u.id === targetUserId);
                if (!targetUser) return { s: false, m: "Utilisateur introuvable" };
                const oldBalance = targetUser.wallet.cash;
                let newBalance = oldBalance;
                let pendingNotifs = targetUser.pending_notifications || [];
                if (type === 'ADD') { newBalance += amount; pendingNotifs = [...pendingNotifs, { id: Date.now(), type: 'MONEY_IN', amount: amount, sender: 'Administration', avatar: 'ADMIN', timestamp: Date.now() }]; }
                if (type === 'REMOVE') { if (oldBalance < amount) return { s: false, m: "Solde insuffisant." }; newBalance -= amount; }
                const logEntry = { id: Date.now(), adminId: 'Admin', targetUserId: targetUser.id, targetUsername: targetUser.discord?.username || 'Unknown', action: type, amount: amount, balanceBefore: oldBalance, balanceAfter: newBalance, reason: reason, timestamp: new Date().toLocaleString('fr-FR'), ip: '127.0.0.1' };
                const newUserState = { ...targetUser, wallet: { ...targetUser.wallet, cash: newBalance }, pending_notifications: pendingNotifs };
                updateUserInDb(newUserState);
                const newLogs = [logEntry, ...adminLogs];
                setAdminLogs(newLogs);
                localStorage.setItem('xaluxa_admin_logs', JSON.stringify(newLogs));
                if (user && user.id === targetUserId) { setUser(newUserState); localStorage.setItem('xaluxa_user', JSON.stringify(newUserState)); }
                return { s: true, m: "Transaction effectuée." };
            };

            const manageMarketAsset = (action, payload) => {
                if(!isAdmin) return;
                let newMarket = [...market];
                if(action==='ADD') newMarket.push({...payload, history:[], change24h:0, active:true, color:'#fff'});
                if(action==='TOGGLE') newMarket = newMarket.map(m=>m.symbol===payload?{...m, active:!m.active}:m);
                if(action==='DELETE') newMarket = newMarket.filter(m=>m.symbol!==payload);
                setMarket(newMarket);
            };

            const adminLogin = (u, p) => {
                if (u === 'test' && p === 'test') { setIsAdmin(true); return true; }
                return false;
            };

            useEffect(() => {
                const interval = setInterval(() => {
                    const newMarket = simulateMarketUpdate(marketRef.current);
                    setMarket(newMarket);
                    const currentUser = userRef.current;
                    const currentOrders = ordersRef.current;
                    if (currentUser && currentOrders.length > 0) {
                        let ordersTriggered = false;
                        let updatedUser = { ...currentUser };
                        let remainingOrders = [...currentOrders];
                        const triggeredIndices = [];
                        remainingOrders.forEach((order, index) => {
                            const asset = newMarket.find(m => m.symbol === order.symbol);
                            if (!asset) return;
                            let triggered = false;
                            if (order.type === 'TP' && asset.price >= order.triggerPrice) triggered = true;
                            if (order.type === 'SL' && asset.price <= order.triggerPrice) triggered = true;
                            if (triggered) {
                                const heldQty = updatedUser.wallet.assets[order.symbol] || 0;
                                const qtyToSell = Math.min(order.qty, heldQty);
                                if (qtyToSell > 0) {
                                    const val = qtyToSell * asset.price;
                                    updatedUser.wallet.cash += val;
                                    updatedUser.wallet.assets[order.symbol] -= qtyToSell;
                                    setTransactions(prev => [{ type: `AUTO_${order.type}`, symbol: order.symbol, qty: qtyToSell, price: asset.price, time: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}) }, ...prev.slice(0, 19)]);
                                }
                                triggeredIndices.push(index);
                                ordersTriggered = true;
                            }
                        });
                        if (ordersTriggered) {
                            const nextOrders = remainingOrders.filter((_, i) => !triggeredIndices.includes(i));
                            updatedUser.activeOrders = nextOrders;
                            setUser(updatedUser); setOrders(nextOrders); updateUserInDb(updatedUser); localStorage.setItem('xaluxa_user', JSON.stringify(updatedUser));
                        }
                    }
                }, 3000);
                return () => clearInterval(interval);
            }, []);

            const logout = () => { setUser(null); setOrders([]); setActivePage('HOME'); localStorage.removeItem('xaluxa_user'); setIsAdmin(false); };
            
            const buyAsset = (s, amt, autoOrders = []) => {
                if(!user) return {s:false, m:'Connectez-vous'};
                const asset = market.find(a => a.symbol === s);
                if(user.wallet.cash < amt) return {s:false, m:'Fonds insuffisants'};
                // Premium check: 0 fees if premium
                const feeRate = isUserPremium(user) ? 0 : FEES.BUY;
                const tax = amt * feeRate; const netInvested = amt - tax; const qty = netInvested / asset.price;
                const newOrders = [...orders];
                if (autoOrders.length > 0) {
                    autoOrders.forEach(o => {
                        const triggerPrice = o.type === 'TP' ? asset.price * (1 + o.percent / 100) : asset.price * (1 - o.percent / 100);
                        newOrders.push({ id: Date.now() + Math.random(), symbol: s, type: o.type, triggerPrice, qty: qty });
                    });
                }
                const newUser = { ...user, activeOrders: newOrders, wallet: { ...user.wallet, cash: user.wallet.cash - amt, assets: {...user.wallet.assets, [s]: (user.wallet.assets[s]||0)+qty} } };
                setUser(newUser); setOrders(newOrders); updateUserInDb(newUser); localStorage.setItem('xaluxa_user', JSON.stringify(newUser));
                setTransactions(prev => [{type: 'BUY', symbol: s, qty: qty, price: asset.price, time: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}, ...prev.slice(0, 19)]);
                return {s:true, m:`Acheté ${qty.toFixed(4)} ${s} (Taxe: $${tax.toFixed(2)})`};
            };

            const sellAsset = (s, qty) => {
                if(!user) return {s:false, m:'Connectez-vous'};
                const asset = market.find(a => a.symbol === s);
                if((user.wallet.assets[s]||0) < qty) return {s:false, m:'Pas assez d\'actifs'};
                const grossVal = qty * asset.price;
                // Premium check: 0 fees if premium
                const feeRate = isUserPremium(user) ? 0 : FEES.SELL;
                const tax = grossVal * feeRate; const netVal = grossVal - tax;
                const newUser = { ...user, wallet: { ...user.wallet, cash: user.wallet.cash + netVal, assets: {...user.wallet.assets, [s]: user.wallet.assets[s]-qty} } };
                setUser(newUser); updateUserInDb(newUser); localStorage.setItem('xaluxa_user', JSON.stringify(newUser));
                setTransactions(prev => [{type: 'SELL', symbol: s, qty: qty, price: asset.price, time: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}, ...prev.slice(0, 19)]);
                return {s:true, m:`Vendu ${qty.toFixed(4)} ${s} (Taxe: $${tax.toFixed(2)})`};
            };

            const transferCash = (toInternalId, amt) => {
                if(user.wallet.cash < amt) return {s:false, m:'Fonds insuffisants'};
                if(toInternalId === user.internalId) return {s:false, m:"Virement vers soi-même impossible"};
                
                const targetUser = allUsers.find(u => u.internalId === toInternalId);
                if(!targetUser) return {s:false, m:"ID introuvable"};

                const newUser = {...user, wallet: {...user.wallet, cash: user.wallet.cash - amt}};
                setUser(newUser); localStorage.setItem('xaluxa_user', JSON.stringify(newUser));
                // Premium check: 0 fees if premium
                const feeRate = isUserPremium(user) ? 0 : FEES.TRANSFER; 
                const fee = amt * feeRate; const transferAmount = amt; 
                
                setAllUsers(prev => prev.map(u => {
                    if (u.id === user.id) return newUser;
                    if (u.id === targetUser.id) {
                        const notif = { id: Date.now(), type: 'MONEY_IN', amount: transferAmount, sender: user.discord?.username || 'Inconnu', avatar: user.discord?.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png', timestamp: Date.now() };
                        return { ...u, wallet: { ...u.wallet, cash: u.wallet.cash + transferAmount }, pending_notifications: [...(u.pending_notifications || []), notif] };
                    }
                    if (user.referredBy && user.referredBy !== SPECIAL_CODES.CRYPTO10 && u.id === user.referredBy) {
                        return { ...u, referralWallet: (u.referralWallet || 0) + fee, totalReferralEarnings: (u.totalReferralEarnings || 0) + fee };
                    }
                    return u;
                }));
                setTransactions(prev => [{type: 'TRANSFER', symbol: 'USD', qty: amt, price: 1, time: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}, ...prev.slice(0, 19)]);
                return {s:true, m:`Virement de $${amt} effectué. (Taxe: $${fee.toFixed(2)})`};
            };

            const donate = () => {
                if(!user) return;
                const amount = 2;
                if(user.wallet.cash < amount) return {s:false, m:"Fonds insuffisants pour le don."};
                const newUser = { ...user, wallet: { ...user.wallet, cash: user.wallet.cash - amount } };
                setUser(newUser); updateUserInDb(newUser); localStorage.setItem('xaluxa_user', JSON.stringify(newUser));
                setTransactions(prev => [{type: 'DONATION', symbol: 'PEACE', qty: amount, price: 1, time: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}, ...prev.slice(0, 19)]);
                return {s:true, m:"Merci pour votre don de $2 !"};
            };

            const getPortfolioValue = () => {
                if(!user) return 0;
                let val = user.wallet.cash;
                Object.entries(user.wallet.assets).forEach(([s, q]) => { const a = market.find(m => m.symbol === s); if(a) val += q * a.price; });
                return val;
            };

            return (
                <MarketContext.Provider value={{ market, user, transactions, allUsers, orders, isLoading, activePage, theme, isAdmin, adminLogs, isProfileOpen, uiNotifications, toggleProfile, adminLogin, toggleTheme, setActivePage, logout, buyAsset, sellAsset, transferCash, getPortfolioValue, applyReferralCode, claimReferralEarnings, generateMyReferralCode, manageUserMoney, isChristmas, toggleChristmasMode, manageMarketAsset, handleUserLogin, donate, manageUserPremium }}>
                    {children}
                </MarketContext.Provider>
            );
        };
        const useMarket = () => useContext(MarketContext);
        
        // --- COMPONENTS ---
        const NotificationContainer = () => {
            const { uiNotifications } = useMarket();
            return (
                <div className="fixed top-24 right-4 z-[100] flex flex-col gap-3 pointer-events-none">
                    {uiNotifications.map(n => (
                        <div key={n.id} className="pointer-events-auto bg-white dark:bg-dark-800 border-l-4 border-emerald-500 shadow-2xl p-4 rounded-r-lg flex items-center gap-4 min-w-[320px] animate-slide-in-right backdrop-blur-md">
                             <div className="relative shrink-0">
                                {n.avatar === 'ADMIN' ? ( <div className="w-12 h-12 rounded-full bg-dark-900 flex items-center justify-center text-gold-500 shadow-inner"><ShieldCheck size={24} /></div> ) : ( <img src={n.avatar} className="w-12 h-12 rounded-full border-2 border-emerald-500 object-cover" /> )}
                                <div className="absolute -bottom-1 -right-1 bg-emerald-500 text-white rounded-full p-1 border-2 border-white dark:border-dark-800"><Plus size={10} /></div>
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-0.5">{n.type === 'MONEY_IN' ? 'Fonds Reçus' : 'Information'}</div>
                                <div className="font-bold dark:text-white text-dark-900 truncate">{n.sender}</div>
                                {n.type === 'MONEY_IN' ? ( <div className="text-emerald-500 font-mono font-black text-xl leading-none">+${n.amount.toLocaleString()}</div> ) : ( <div className="text-gray-500 text-xs">{n.message}</div> )}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const Logo = ({ size = 'md' }) => {
            const { isChristmas } = useMarket();
            return (
                <div className="flex items-center gap-2 font-bold tracking-wider select-none cursor-pointer relative btn-hover">
                     {isChristmas && ( <div className="absolute -top-3 -left-2 transform -rotate-12 pointer-events-none animate-float"><Snowflake className="text-white fill-white" size={24} /></div> )}
                    <div className="relative flex items-center justify-center">
                        <Activity className={`text-gold-500 ${size === 'lg' ? 'w-10 h-10' : 'w-6 h-6'}`} />
                        <TrendingUp className={`absolute -top-1 -right-1 text-emerald-500 ${size === 'lg' ? 'w-6 h-6' : 'w-4 h-4'}`} />
                    </div>
                    <div className={`flex flex-col leading-none`}>
                        <span className={`${size==='sm'?'text-lg':'text-2xl'} dark:text-white text-dark-950 transition-theme`}>XALUXA</span>
                        <span className={`text-[0.6rem] tracking-[0.2em] uppercase ${isChristmas ? 'text-christmas-red' : 'text-gold-500'}`}>Agency</span>
                    </div>
                </div>
            );
        };

        const ThemeToggle = () => {
            const { theme, toggleTheme, isChristmas, toggleChristmasMode } = useMarket();
            return (
                <div className="flex gap-2">
                    <button onClick={toggleChristmasMode} className={`p-2 rounded-full hover:bg-gray-200 dark:hover:bg-dark-800 transition-all btn-hover ${isChristmas ? 'text-christmas-red bg-christmas-red/10' : 'text-gray-400'}`} title={isChristmas ? "Désactiver Mode Noël" : "Activer Mode Noël"}><Gift size={20} /></button>
                    <button onClick={toggleTheme} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-dark-800 transition-all text-gold-500 dark:text-gold-400 btn-hover">{theme === 'dark' ? <Sun size={20} /> : <Moon size={20} />}</button>
                </div>
            );
        };

        const AdminAccessButton = () => {
            const { setActivePage } = useMarket();
            return (
                <div className="fixed bottom-0 left-0 w-24 h-24 z-[9999] flex items-end justify-start p-4 opacity-0 hover:opacity-100 transition-opacity duration-300">
                    <button onClick={() => setActivePage('ADMIN_LOGIN')} className="p-3 bg-red-600/80 text-white rounded-full shadow-2xl backdrop-blur-md hover:scale-110 transition-transform" title="Admin"><Lock size={20} /></button>
                </div>
            );
        };

        const DemoAccessButton = () => {
             const { handleUserLogin, setActivePage } = useMarket();
             const [isOpen, setIsOpen] = useState(false);
             const [code, setCode] = useState('');

             const handleUnlock = () => {
                 if(code === 'test test') {
                     handleUserLogin({
                        id: 'demo-user-' + Date.now(),
                        internalId: 'DEMO-USER-ID',
                        discord: { id: 'demo', username: 'Demo Trader', avatar: 'https://cdn.discordapp.com/embed/avatars/0.png' },
                        wallet: { cash: 0, assets: { 'ATERIS': 0, 'BALIEM': 0, 'BASTRUM': 0, 'UDC': 0 } }
                     });
                     setActivePage('DASHBOARD');
                     setIsOpen(false);
                     setCode('');
                 } else {
                     alert("Code invalide");
                 }
             };

             return (
                 <>
                 <div className="fixed bottom-0 right-0 w-24 h-24 z-[9999] flex items-end justify-end p-4 opacity-0 hover:opacity-100 transition-opacity duration-300">
                     <button onClick={() => setIsOpen(true)} className="p-3 bg-blue-600/80 text-white rounded-full shadow-2xl backdrop-blur-md hover:scale-110 transition-transform" title="Mode Démo"><Gamepad size={20} /></button>
                 </div>
                 {isOpen && (
                     <div className="fixed inset-0 z-[10000] flex items-center justify-center bg-black/80 backdrop-blur-sm" onClick={() => setIsOpen(false)}>
                         <div className="bg-white dark:bg-dark-800 p-6 rounded-xl shadow-2xl border dark:border-dark-700 w-full max-w-sm m-4" onClick={e => e.stopPropagation()}>
                             <h3 className="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><Gamepad className="text-blue-500" /> Mode Démo</h3>
                             <p className="text-sm text-gray-500 mb-4">Entrez le code d'accès pour activer la session de démonstration.</p>
                             <input type="text" placeholder="Code d'accès" className="w-full p-3 mb-4 rounded-lg bg-gray-100 dark:bg-dark-900 dark:text-white border border-gray-200 dark:border-dark-600 focus:ring-2 ring-blue-500 outline-none" value={code} onChange={e => setCode(e.target.value)} />
                             <button onClick={handleUnlock} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold transition-colors">Activer</button>
                         </div>
                     </div>
                 )}
                 </>
             );
        };

        const NavBar = () => {
            const { setActivePage, user, theme, isChristmas } = useMarket();
            const redirectUri = window.location.origin + window.location.pathname;
            const discordLoginUrl = `https://discord.com/oauth2/authorize?client_id=1453040768380833946&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=identify`;

            return (
                <nav className="container mx-auto px-6 py-6 flex justify-between items-center relative z-20">
                     {isChristmas && <div className="garland-container">{[...Array(20)].map((_, i) => <div key={i} className="garland-bulb"></div>)}</div>}
                    <div onClick={() => setActivePage(user ? 'DASHBOARD' : 'HOME')}><Logo /></div>
                    <div className="hidden md:flex items-center gap-8 text-sm font-bold uppercase tracking-wider dark:text-gray-400 text-gray-600 transition-theme">
                        <button onClick={() => setActivePage('HOME')} className="hover:text-gold-500 transition-colors btn-hover">Accueil</button>
                        <button onClick={() => setActivePage('TRANSFER')} className="hover:text-gold-500 transition-colors btn-hover">Virements</button>
                        <button onClick={() => setActivePage('REFERRAL')} className="hover:text-gold-500 transition-colors btn-hover">Affiliation</button>
                    </div>
                    <div className="flex items-center gap-4">
                        <ThemeToggle />
                        {user ? (
                            <button onClick={() => setActivePage('DASHBOARD')} className={`text-white px-4 py-2 rounded font-bold hover:opacity-90 transition-all shadow-lg btn-hover ${isChristmas ? 'bg-gradient-to-r from-christmas-red to-christmas-green' : 'bg-gold-500 shadow-gold-500/20'}`}>Dashboard</button>
                        ) : (
                            <a href={discordLoginUrl} className="bg-discord-blue text-white px-5 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-opacity-90 transition-all btn-hover"><i className="fa-brands fa-discord"></i><span className="hidden sm:inline">Connexion</span></a>
                        )}
                    </div>
                </nav>
            );
        };

        const ProfileModal = ({ isOpen, onClose }) => {
            const { user, getPortfolioValue, setActivePage } = useMarket();
            if (!isOpen || !user) return null;
            const netWorth = getPortfolioValue();
            const avatar = user.discord ? user.discord.avatar : 'https://cdn.discordapp.com/embed/avatars/0.png';
            const username = user.discord ? user.discord.username : 'User';
            const isPremium = isUserPremium(user);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm animate-fade-in p-4" onClick={onClose}>
                    <div className="bg-white dark:bg-dark-800 rounded-2xl p-6 w-full max-w-md shadow-2xl relative animate-slide-up border dark:border-dark-700 border-light-200 transition-theme overflow-hidden" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-rose-500 z-10"><X /></button>
                        <div className="flex flex-col items-center mb-6">
                            <div className="relative">
                                <img src={avatar} className={`w-24 h-24 rounded-full border-4 ${isPremium ? 'border-gold-500 shadow-[0_0_15px_rgba(245,158,11,0.5)]' : 'border-gray-200 dark:border-gray-700'} shadow-lg mb-3 object-cover`} />
                                {isPremium && <div className="absolute -top-3 -right-3 text-gold-500 bg-white dark:bg-dark-800 rounded-full p-1"><Crown size={24} fill="#f59e0b" /></div>}
                            </div>
                            <h2 className="text-2xl font-bold dark:text-white text-dark-900 flex items-center gap-2">{username}</h2>
                            <span className={`text-xs uppercase tracking-widest px-2 py-1 rounded mt-2 font-bold ${isPremium ? 'bg-gold-500 text-white' : 'bg-gray-100 dark:bg-dark-900 text-gray-500'}`}>{isPremium ? 'Premium Member' : 'Membre Standard'}</span>
                            <div className="text-xs text-gray-500 font-mono mt-1">ID: {user.internalId}</div>
                        </div>
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="p-4 rounded-xl bg-gray-50 dark:bg-dark-900 text-center"><p className="text-xs text-gray-500 uppercase">Valeur Nette</p><p className="text-xl font-bold text-gold-500">${netWorth.toLocaleString(undefined, {maximumFractionDigits:0})}</p></div>
                            <div className="p-4 rounded-xl bg-gray-50 dark:bg-dark-900 text-center"><p className="text-xs text-gray-500 uppercase">Cash</p><p className="text-xl font-bold text-emerald-500">${user.wallet.cash.toLocaleString(undefined, {maximumFractionDigits:0})}</p></div>
                        </div>
                        <div className="mb-6 flex gap-2">
                             <button onClick={() => { setActivePage('WALLET'); onClose(); }} className="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-bold text-sm btn-hover"><Wallet className="inline mr-2" size={16}/> Portefeuille</button>
                             <button onClick={() => { setActivePage('TRANSFER'); onClose(); }} className="flex-1 bg-gray-200 dark:bg-dark-700 hover:bg-gray-300 dark:hover:bg-dark-600 dark:text-white py-3 rounded-lg font-bold text-sm btn-hover"><Send className="inline mr-2" size={16}/> Virements</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardNavBar = () => {
            const { user, getPortfolioValue, logout, setActivePage, isProfileOpen, toggleProfile } = useMarket();
            const totalValue = getPortfolioValue();
            if (!user) return null;
            const avatar = user.discord ? user.discord.avatar : 'https://cdn.discordapp.com/embed/avatars/0.png';
            const username = user.discord ? user.discord.username : 'User';
            const isPremium = isUserPremium(user);

            return (
                <>
                <div className="sticky top-0 z-40 backdrop-blur-md dark:bg-dark-900/90 bg-white/90 border-b dark:border-gold-500/30 border-gray-200 transition-theme p-3">
                    <div className="container mx-auto flex flex-wrap justify-between items-center gap-4">
                        <div className="flex items-center gap-4 cursor-pointer hover:opacity-80 transition-opacity" onClick={() => toggleProfile(true)}>
                            <div className="relative">
                                <img src={avatar} alt="Avatar" className={`w-10 h-10 rounded-full border-2 ${isPremium ? 'border-gold-500' : 'border-gray-200'} object-cover`} />
                                <div className="absolute -bottom-1 -right-1 bg-green-500 w-3 h-3 rounded-full border-2 border-white dark:border-dark-900"></div>
                            </div>
                            <div className="hidden sm:block">
                                <div className="font-bold dark:text-white text-dark-900 text-sm flex items-center gap-1">
                                    {username} {isPremium && <Crown size={12} className="text-gold-500" fill="#f59e0b"/>}
                                </div>
                                <div className="text-xs text-emerald-500 font-mono">${totalValue.toLocaleString()}</div>
                            </div>
                        </div>
                         <div className="flex items-center gap-2 md:gap-6 font-bold text-xs md:text-sm uppercase tracking-wider dark:text-gray-300 text-gray-700">
                             <button onClick={() => setActivePage('HOME')} className="hidden sm:block hover:text-gold-500 transition-colors btn-hover">Accueil</button>
                             <button onClick={() => setActivePage('WALLET')} className="hover:text-gold-500 transition-colors flex items-center gap-2 btn-hover"><Wallet size={16}/> <span className="hidden sm:inline">Portefeuille</span></button>
                             <button onClick={() => setActivePage('TRANSFER')} className="hover:text-gold-500 transition-colors flex items-center gap-2 btn-hover"><Send size={16}/> <span className="hidden sm:inline">Virements</span></button>
                             <button onClick={() => setActivePage('REFERRAL')} className="hover:text-gold-500 transition-colors flex items-center gap-2 btn-hover"><Users size={16}/> <span className="hidden sm:inline">Affiliation</span></button>
                         </div>
                        <div className="flex items-center gap-2">
                            <ThemeToggle />
                            <button onClick={logout} className="p-2 rounded-lg bg-rose-500/10 text-rose-500 hover:bg-rose-500/20 transition-colors btn-hover" title="Déconnexion"><LogOut size={18} /></button>
                        </div>
                    </div>
                </div>
                <ProfileModal isOpen={isProfileOpen} onClose={() => toggleProfile(false)} />
                </>
            );
        };

        const CustomTooltip = ({ active, payload, label, isMobile }) => {
            const { theme } = useMarket();
            const isDark = theme === 'dark';
            if (active && payload && payload.length) {
                const data = payload[0].payload;
                return (
                    <div className={`p-3 rounded-lg shadow-xl border text-xs font-mono transition-colors duration-200 ${isDark ? 'bg-dark-800 border-dark-700 text-white' : 'bg-white border-gray-200 text-gray-800'}`}>
                        <div className="font-bold mb-1 opacity-70">{data.time}</div>
                        <div className="grid grid-cols-2 gap-x-4">
                            <span className="text-emerald-500">O: ${data.open.toFixed(2)}</span>
                            <span className={data.close >= data.open ? 'text-emerald-500' : 'text-rose-500'}>C: ${data.close.toFixed(2)}</span>
                            <span className="opacity-70">H: ${data.high.toFixed(2)}</span>
                            <span className="opacity-70">L: ${data.low.toFixed(2)}</span>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const AssetChart = ({ asset }) => {
            const { theme, user } = useMarket();
            const isMobile = useMediaQuery("(max-width: 768px)");
            const isDark = theme === 'dark';
            const isPremium = isUserPremium(user);
            
            const data = asset.history.map(h => ({
                ...h,
                body: [Math.min(h.open, h.close), Math.max(h.open, h.close)], 
                wick: [h.low, h.high],
                color: h.close >= h.open ? '#10b981' : '#ef4444'
            }));

            const allValues = asset.history.flatMap(h => [h.low, h.high]);
            const minVal = Math.min(...allValues);
            const maxVal = Math.max(...allValues);
            const padding = (maxVal - minVal) * 0.05; 
            const domain = [minVal - padding, maxVal + padding];

            const [drawMode, setDrawMode] = useState(false);
            const [lines, setLines] = useState([]);

            const handleChartClick = (e) => {
                if(!drawMode || !e?.activePayload) return;
                setLines([...lines, {y: e.activePayload[0].payload.price, color: '#10b981'}]); 
                setDrawMode(false);
            };

            const toggleDraw = () => {
                if (!isPremium) return alert("Fonctionnalité réservée aux membres Premium !");
                setDrawMode(!drawMode);
            };

            return (
                <div className="bg-white dark:bg-dark-800 rounded-xl p-4 md:p-6 shadow-xl border dark:border-dark-700 border-light-200 h-80 md:h-96 flex flex-col transition-theme w-full reveal delay-100 relative group">
                    <div className="flex justify-between items-end mb-4">
                        <div><h3 className="text-xl md:text-2xl font-bold dark:text-white text-dark-900">{asset.name}</h3><span className="text-xs md:text-sm text-gray-500">{asset.symbol}/USD</span></div>
                        <div className={`text-right ${asset.change24h >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                            <div className="text-xl md:text-2xl font-mono font-bold">${asset.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</div>
                            <div className="text-xs md:text-sm font-bold">{asset.change24h > 0 ? '+' : ''}{asset.change24h.toFixed(2)}%</div>
                        </div>
                    </div>

                    <div className="absolute top-4 right-4 z-10 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <div className="relative group/btn">
                            <button onClick={toggleDraw} className={`p-2 text-xs rounded font-bold shadow transition-colors flex items-center gap-1 ${drawMode?'bg-purple-600 text-white': isPremium ? 'bg-gray-200 dark:bg-dark-600 dark:text-gray-400' : 'bg-gray-300 dark:bg-dark-900 text-gray-500 cursor-not-allowed'}`} title={isPremium ? "Tracer ligne" : "Premium Only"}>
                                <Edit2 size={14}/> {!isPremium && <Lock size={10} />}
                            </button>
                        </div>
                        {lines.length > 0 && <button onClick={()=>setLines([])} className="p-2 text-xs rounded font-bold bg-rose-500 text-white shadow" title="Effacer lignes"><Trash size={14}/></button>}
                    </div>

                    <div className={`flex-1 w-full relative ${drawMode ? 'cursor-crosshair' : ''}`}>
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={data} onClick={handleChartClick} barGap={-5}>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} opacity={0.1} stroke={isDark ? '#fff' : '#000'} />
                                <XAxis dataKey="time" tick={{fontSize: 10, fill: isDark ? '#94a3b8' : '#64748b'}} axisLine={false} tickLine={false} minTickGap={30} hide={isMobile} />
                                <YAxis domain={domain} orientation="right" tick={{fontSize: 11, fill: isDark ? '#94a3b8' : '#64748b'}} axisLine={false} tickLine={false} tickFormatter={(v) => `$${v.toFixed(0)}`} width={isMobile ? 40 : 60}/>
                                <Tooltip content={<CustomTooltip isMobile={isMobile} />} cursor={{fill: isDark ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.03)'}} />
                                <Bar dataKey="wick" xAxisId={0} barSize={1} isAnimationActive={false}>
                                    {data.map((entry, index) => <Cell key={`wick-${index}`} fill={entry.color} />)}
                                </Bar>
                                <Bar dataKey="body" xAxisId={0} barSize={isMobile ? 6 : 10} isAnimationActive={false}>
                                    {data.map((entry, index) => <Cell key={`body-${index}`} fill={entry.color} />)}
                                </Bar>
                                {lines.map((l, i) => <ReferenceLine key={i} y={l.y} stroke={l.color} strokeDasharray="5 5" strokeWidth={1} label={{ value: l.y.toFixed(2), position: 'right', fill: l.color, fontSize: 10 }} />)}
                            </BarChart>
                        </ResponsiveContainer>
                        {drawMode && <div className="absolute top-1/2 left-1/2 -translate-x-1/2 bg-purple-500 text-white px-3 py-1 rounded-full text-xs animate-pulse pointer-events-none shadow-lg">Cliquez sur le graphique pour placer une ligne de prix</div>}
                    </div>
                </div>
            );
        };

        const TradePanel = ({ asset }) => {
            const { buyAsset, sellAsset, user } = useMarket();
            const [amt, setAmt] = useState('');
            const [msg, setMsg] = useState(null);
            const [useAuto, setUseAuto] = useState(false);
            const [tp, setTp] = useState('');
            const [sl, setSl] = useState('');
            const isPremium = isUserPremium(user);
            const fees = isPremium ? 0 : 2;

            const exec = (type) => {
                if(!user) return setMsg({t:'err', m:'Non connecté'});
                const val = parseFloat(amt);
                if(isNaN(val) || val <= 0) return setMsg({t:'err', m:'Montant invalide'});
                let orders = [];
                if (type === 'BUY' && useAuto) {
                    if(!isPremium) return setMsg({t:'err', m:'Fonction Auto-Trade réservée aux Premium'});
                    if (tp) orders.push({ type: 'TP', percent: parseFloat(tp) });
                    if (sl) orders.push({ type: 'SL', percent: parseFloat(sl) });
                }
                const res = type === 'BUY' ? buyAsset(asset.symbol, val, orders) : sellAsset(asset.symbol, val);
                setMsg({t: res.s?'suc':'err', m: res.m});
                if(res.s) { setAmt(''); setTp(''); setSl(''); }
                setTimeout(() => setMsg(null), 3000);
            };

            const toggleAuto = (e) => {
                 if(!isPremium) {
                     setMsg({t:'err', m:'Fonctionnalité Premium requise'});
                     setTimeout(()=>setMsg(null), 2000);
                     return;
                 }
                 setUseAuto(e.target.checked);
            };

            return (
                <div className="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-xl border dark:border-dark-700 border-light-200 h-full flex flex-col transition-theme reveal delay-200">
                    <h3 className="text-lg font-bold dark:text-gray-200 text-gray-700 mb-4 uppercase tracking-wide flex justify-between items-center">Passer un ordre</h3>
                    <div className="flex-1 flex flex-col gap-4">
                        <input type="number" placeholder="Quantité ($)" className="w-full bg-gray-100 dark:bg-dark-900 p-4 rounded-lg outline-none focus:ring-2 ring-gold-500 dark:text-white transition-all" value={amt} onChange={e => setAmt(e.target.value)} />
                        <div className={`p-4 rounded-lg border transition-all ${isPremium ? 'bg-gray-100 dark:bg-dark-900 border-transparent' : 'bg-gray-50 dark:bg-dark-900/50 border-gray-200 dark:border-dark-700 opacity-60'}`}>
                            <div className="flex justify-between items-center mb-2">
                                <label className={`flex items-center gap-2 text-xs font-bold uppercase cursor-pointer select-none ${!isPremium && 'cursor-not-allowed'}`}>
                                    <input type="checkbox" className="w-4 h-4 accent-gold-500" checked={useAuto} onChange={toggleAuto} disabled={!isPremium} />
                                    <span className="text-gray-500 flex items-center gap-2">Auto Take-Profit {!isPremium && <Lock size={12}/>}</span>
                                </label>
                            </div>
                            {useAuto && (
                                <div className="grid grid-cols-2 gap-2 animate-fade-in">
                                    <div><span className="text-[10px] text-emerald-500 font-bold block mb-1">TP (+%)</span><input type="number" placeholder="20" className="w-full bg-white dark:bg-dark-800 p-2 rounded text-sm outline-none border border-emerald-500/30 text-emerald-600 font-bold" value={tp} onChange={e => setTp(e.target.value)} /></div>
                                    <div><span className="text-[10px] text-rose-500 font-bold block mb-1">SL (-%)</span><input type="number" placeholder="10" className="w-full bg-white dark:bg-dark-800 p-2 rounded text-sm outline-none border border-rose-500/30 text-rose-600 font-bold" value={sl} onChange={e => setSl(e.target.value)} /></div>
                                </div>
                            )}
                        </div>
                        <div className="text-xs text-gray-500 text-center italic">Frais : {isPremium ? <span className="text-gold-500 font-bold">0% (Premium)</span> : <span className="text-rose-500 font-bold">{fees}%</span>}</div>
                        <div className="grid grid-cols-2 gap-3 mt-auto"><button onClick={() => exec('BUY')} className="bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-lg font-bold transition-all btn-hover">ACHETER</button><button onClick={() => exec('SELL')} className="bg-rose-500 hover:bg-rose-600 text-white py-3 rounded-lg font-bold transition-all btn-hover">VENDRE</button></div>
                        {msg && <div className={`p-2 rounded text-center text-sm ${msg.t==='suc'?'bg-emerald-100 text-emerald-700':'bg-rose-100 text-rose-700'}`}>{msg.m}</div>}
                    </div>
                </div>
            );
        };

        const TransactionHistory = () => {
            const { transactions } = useMarket();
            return (
                <div className="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-xl border dark:border-dark-700 border-light-200 h-80 flex flex-col transition-theme reveal delay-300">
                    <div className="flex items-center gap-2 mb-4"><Clock className="text-gray-400" size={20} /><h3 className="text-lg font-bold dark:text-gray-200 text-gray-700 uppercase tracking-wide">Historique</h3></div>
                    <div className="flex-1 overflow-y-auto space-y-3 pr-2">
                        {transactions.length === 0 ? ( <div className="text-center text-gray-500 text-sm mt-10">Aucune transaction récente</div> ) : (
                            transactions.map((t, i) => (
                                <div key={i} className="flex justify-between items-center p-3 rounded-lg bg-gray-50 dark:bg-dark-900 hover:bg-gray-100 dark:hover:bg-dark-700 transition-colors">
                                    <div className="flex flex-col">
                                        <div className="flex items-center gap-2">
                                            <span className={`text-xs font-bold px-2 py-0.5 rounded ${t.type.includes('BUY') ? 'bg-emerald-100 text-emerald-600' : t.type.includes('SELL') ? 'bg-rose-100 text-rose-600' : 'bg-blue-100 text-blue-600'}`}>{t.type}</span>
                                            <span className="font-bold dark:text-white text-dark-900">{t.symbol}</span>
                                        </div>
                                        <span className="text-xs text-gray-500">{t.time}</span>
                                    </div>
                                    <div className="text-right"><div className="font-mono text-sm dark:text-gray-300 text-gray-700">{typeof t.qty === 'number' ? t.qty.toFixed(4) : t.qty}</div><div className="text-xs text-gray-500">@ ${t.price.toLocaleString()}</div></div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const NewsFeed = () => {
            const { user } = useMarket();
            const isPremium = isUserPremium(user);
            const futureNews = [
                { week: "Semaine du 27 Octobre 2025", title: "Régulation des Crypto-Actifs", desc: "Le vote parlementaire sur la fiscalité des actifs numériques est prévu pour vendredi." },
                { week: "Semaine du 3 Novembre 2025", title: "Mise à jour Réseau BASTRUM", desc: "Le protocole Bastrum prévoit une migration majeure de ses nœuds validateurs." },
                { week: "Semaine du 10 Novembre 2025", title: "Rapport Inflation US", desc: "Les chiffres de l'inflation américaine seront publiés, forte volatilité attendue." },
                { week: "Semaine du 17 Novembre 2025", title: "Lancement ATERIS V2", desc: "La nouvelle version de la blockchain Ateris sera déployée sur le mainnet." }
            ];

            const currentNews = [
                 { week: "Aujourd'hui", title: "Flash Market", desc: "Le marché est stable avec une légère tendance haussière sur Ateris." },
                 { week: "Aujourd'hui", title: "Volumes", desc: "Les volumes d'échange sont modérés en cette session asiatique." }
            ];

            const displayNews = isPremium ? futureNews : currentNews;

            return (
                <div className="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-xl border dark:border-dark-700 border-light-200 h-80 flex flex-col transition-theme reveal delay-200 relative overflow-hidden">
                    <div className="flex items-center gap-2 mb-6 relative z-10">
                        <Calendar className="text-gold-500" size={20} />
                        <h3 className="text-lg font-bold dark:text-gray-200 text-gray-700 uppercase tracking-wide">{isPremium ? "Actualités Futures (Premium)" : "Actualités Instantanées"}</h3>
                    </div>
                    
                    {!isPremium && (
                        <div className="absolute inset-x-0 bottom-0 top-16 z-20 flex flex-col items-center justify-center text-center p-4">
                             <div className="absolute inset-0 bg-white/60 dark:bg-dark-900/60 backdrop-blur-sm"></div>
                             <div className="relative z-30 max-w-xs">
                                 <div className="w-12 h-12 bg-gold-500 rounded-full flex items-center justify-center text-white mx-auto mb-3 shadow-lg"><Lock size={20}/></div>
                                 <h4 className="font-bold text-dark-900 dark:text-white mb-2">Accès Futur Restreint</h4>
                                 <p className="text-xs text-gray-600 dark:text-gray-300 mb-3">Passez Premium pour voir les prédictions et actualités à venir.</p>
                             </div>
                        </div>
                    )}

                    <div className="flex-1 overflow-y-auto pr-2 relative z-10">
                        <div className="absolute left-3 top-0 bottom-0 w-0.5 bg-gray-200 dark:bg-dark-700"></div>
                        <div className="space-y-6 pl-8">
                            {displayNews.map((news, i) => (
                                <div key={i} className="relative">
                                    <div className="absolute -left-[29px] top-1 w-4 h-4 rounded-full bg-gold-500 border-2 border-white dark:border-dark-800 z-10"></div>
                                    <div className="text-xs font-bold text-emerald-500 uppercase tracking-wider mb-1">{news.week}</div>
                                    <h4 className="text-sm font-bold dark:text-white text-dark-900 mb-1">{news.title}</h4>
                                    <p className="text-xs text-gray-500 leading-relaxed">{news.desc}</p>
                                </div>
                            ))}
                            {!isPremium && futureNews.map((news, i) => (
                                <div key={'fake'+i} className="relative opacity-20 filter blur-sm select-none">
                                    <div className="absolute -left-[29px] top-1 w-4 h-4 rounded-full bg-gray-400 border-2 border-white dark:border-dark-800 z-10"></div>
                                    <div className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Semaine prochaine</div>
                                    <h4 className="text-sm font-bold dark:text-white text-dark-900 mb-1">Contenu Premium Masqué</h4>
                                    <p className="text-xs text-gray-500 leading-relaxed">Cette information est réservée aux membres ayant un accès Premium actif.</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const LeaderboardWidget = () => {
            const ranks = [ { n: 'CryptoKing', v: '$145k', c: 'text-gold-500' }, { n: 'Satoshi_Fan', v: '$132k', c: 'text-gray-400' }, { n: 'BullRun2025', v: '$110k', c: 'text-amber-700' } ];
            return (
                <div className="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-xl border dark:border-dark-700 border-light-200 h-80 flex flex-col transition-theme reveal">
                    <div className="flex items-center gap-2 mb-4"><Trophy className="text-purple-500" size={20} /><h3 className="text-lg font-bold dark:text-gray-200 text-gray-700 uppercase tracking-wide">Top Traders</h3></div>
                    <div className="space-y-3">{ranks.map((r, i) => ( <div key={i} className="flex items-center justify-between p-2 rounded hover:bg-gray-50 dark:hover:bg-dark-900 transition-colors"><div className="flex items-center gap-3"><span className={`font-mono font-bold w-4 text-center ${i<3 ? r.c : 'text-gray-500'}`}>{i+1}</span><span className="text-sm font-medium dark:text-gray-300 text-gray-700">{r.n}</span></div><span className="text-sm font-bold text-emerald-500">{r.v}</span></div> ))}</div>
                </div>
            );
        };

        // --- PAGE COMPONENTS ---
        const Dashboard = () => {
            const { market, user, setActivePage, getPortfolioValue, toggleProfile, donate } = useMarket();
            const [sel, setSel] = useState('ATERIS');
            const asset = market.find(m => m.symbol === sel) || market[0];
            const netWorth = getPortfolioValue();
            const [donateMsg, setDonateMsg] = useState(null);
            
            const handleDonate = () => {
                const res = donate();
                if(res) {
                    setDonateMsg(res);
                    setTimeout(() => setDonateMsg(null), 3000);
                }
            };

            useScrollReveal([user]);

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-dark-950 transition-theme pb-20 relative">
                    <DashboardNavBar />
                    <div className="container mx-auto p-4 md:p-6 space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="bg-white dark:bg-dark-800 p-6 rounded-xl shadow-lg border dark:border-dark-700 border-light-200 flex items-center gap-4 reveal">
                                <div className="bg-gold-500/10 p-3 rounded-lg text-gold-500"><Briefcase size={24}/></div>
                                <div><div className="text-gray-500 text-xs font-bold uppercase tracking-wider">Valeur Nette</div><div className="text-2xl font-black dark:text-white text-dark-900">${netWorth.toLocaleString(undefined, {maximumFractionDigits:0})}</div></div>
                            </div>
                            <div className="bg-white dark:bg-dark-800 p-6 rounded-xl shadow-lg border dark:border-dark-700 border-light-200 flex items-center gap-4 reveal delay-100">
                                <div className="bg-emerald-500/10 p-3 rounded-lg text-emerald-500"><DollarSign size={24}/></div>
                                <div><div className="text-gray-500 text-xs font-bold uppercase tracking-wider">Cash Disponible</div><div className="text-2xl font-black dark:text-white text-dark-900">${user.wallet.cash.toLocaleString(undefined, {maximumFractionDigits:2})}</div></div>
                            </div>
                             <div className="bg-white dark:bg-dark-800 p-6 rounded-xl shadow-lg border dark:border-dark-700 border-light-200 flex items-center gap-4 reveal delay-200">
                                <div className="bg-blue-500/10 p-3 rounded-lg text-blue-500"><Layers size={24}/></div>
                                <div><div className="text-gray-500 text-xs font-bold uppercase tracking-wider">Actifs Détenus</div><div className="text-2xl font-black dark:text-white text-dark-900">{Object.values(user.wallet.assets).reduce((a,b)=>a+(b>0?1:0),0)} <span className="text-sm font-normal text-gray-500">/ 4</span></div></div>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                             <button onClick={handleDonate} className="bg-white dark:bg-dark-800 p-4 rounded-xl shadow border dark:border-dark-700 flex items-center justify-center gap-2 hover:bg-gray-50 dark:hover:bg-dark-700 transition btn-hover relative overflow-hidden col-span-4 md:col-span-1">
                                <Gift className="text-rose-500" /> <span className="font-bold dark:text-white">Don Paix ($2)</span>
                                {donateMsg && <div className={`absolute inset-0 flex items-center justify-center text-xs font-bold ${donateMsg.s ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}`}>{donateMsg.m}</div>}
                             </button>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            {market.filter(m=>m.active).map((m, idx) => (
                                <button key={m.symbol} onClick={() => setSel(m.symbol)} className={`p-4 rounded-xl border text-left transition-all btn-hover reveal delay-${(idx+1)*100} ${sel === m.symbol ? 'border-gold-500 bg-white dark:bg-dark-800 shadow-lg ring-1 ring-gold-500' : 'border-transparent bg-white dark:bg-dark-900 hover:bg-gray-50 dark:hover:bg-dark-800'}`}>
                                    <div className="font-bold text-gray-500 text-xs mb-1 uppercase tracking-tighter">{m.name}</div>
                                    <div className="font-mono font-bold dark:text-white text-dark-900 text-sm md:text-base">${m.price.toLocaleString(undefined,{maximumFractionDigits:2})}</div>
                                    <div className={`text-xs font-bold ${m.change24h>=0?'text-emerald-500':'text-rose-500'}`}>{m.change24h>0?'+':''}{m.change24h.toFixed(2)}%</div>
                                </button>
                            ))}
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 w-full"><AssetChart asset={asset} /></div>
                            <div className="w-full"><TradePanel asset={asset} /></div>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6"><LeaderboardWidget /><TransactionHistory /><NewsFeed /></div>
                    </div>
                </div>
            );
        };

        const Home = () => {
            const { user, setActivePage } = useMarket();
            useScrollReveal();
            const redirectUri = window.location.origin + window.location.pathname;
            const discordLoginUrl = `https://discord.com/oauth2/authorize?client_id=1453040768380833946&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=identify`;

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-dark-950 transition-theme flex flex-col relative overflow-hidden">
                    <NavBar />
                    <header className="container mx-auto px-6 py-20 flex flex-col lg:flex-row items-center gap-12">
                        <div className="lg:w-1/2 space-y-6 reveal">
                            <span className="text-gold-500 font-bold tracking-widest uppercase text-sm bg-gold-500/10 px-3 py-1 rounded-full">Trading V2.0</span>
                            <h1 className="text-5xl lg:text-7xl font-black dark:text-white text-dark-900 leading-tight">Le Trading <br /><span className="text-gold-500">Haute Fréquence.</span></h1>
                            <p className="text-lg text-gray-500 dark:text-gray-400 max-w-lg">Apprenez, expérimentez et maîtrisez les marchés crypto volatils. Rejoignez l'élite des traders.</p>
                            <div className="flex flex-col sm:flex-row gap-4 pt-4">
                                {user ? (
                                    <button onClick={() => setActivePage('DASHBOARD')} className="bg-gradient-to-r from-gold-600 to-gold-400 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-xl hover:scale-105 transition-transform flex items-center justify-center gap-3 btn-hover"><Activity /> Accéder au Dashboard</button>
                                ) : (
                                    <a href={discordLoginUrl} className="bg-discord-blue text-white px-6 py-4 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-opacity-90 transition-colors shadow-lg btn-hover"><i className="fa-brands fa-discord text-xl"></i> Connexion Discord</a>
                                )}
                                <button onClick={() => setActivePage('REFERRAL')} className="bg-dark-900 text-white px-6 py-4 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-dark-800 transition-colors shadow-lg border border-gray-700 btn-hover"><Users /> Affiliation</button>
                            </div>
                        </div>
                        <div className="lg:w-1/2 relative hidden md:block reveal delay-200">
                            <div className="absolute inset-0 bg-gradient-to-r from-gold-500 to-purple-600 rounded-full blur-[100px] opacity-20 animate-pulse-fast"></div>
                            <div className="relative z-10 bg-dark-800 rounded-3xl p-6 border dark:border-dark-700 shadow-2xl transform rotate-2">
                                <div className="flex items-center gap-4 mb-4 border-b border-gray-700 pb-4">
                                    <div className="w-3 h-3 rounded-full bg-rose-500"></div>
                                    <div className="w-3 h-3 rounded-full bg-gold-500"></div>
                                    <div className="w-3 h-3 rounded-full bg-emerald-500"></div>
                                </div>
                                <div className="space-y-4">
                                    <div className="h-8 bg-dark-700 rounded w-3/4 animate-pulse"></div>
                                    <div className="h-32 bg-dark-900 rounded w-full border border-dark-700 flex items-end justify-around pb-2 px-2 overflow-hidden">
                                        {[40, 60, 45, 70, 65, 85, 80, 95].map((h, i) => (
                                            <div key={i} className="w-6 bg-gold-500/20 rounded-t" style={{height: `${h}%`}}></div>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="h-20 bg-dark-700/50 rounded animate-pulse"></div>
                                        <div className="h-20 bg-dark-700/50 rounded animate-pulse"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>
                    <section className="py-20 bg-white dark:bg-dark-900 transition-theme">
                        <div className="container mx-auto px-6"><h2 className="text-3xl font-bold text-center mb-16 dark:text-white text-dark-900 reveal">Comment ça marche ?</h2><div className="grid md:grid-cols-3 gap-10">{[{icon: <Briefcase />, title: "1. Connectez-vous", desc: "Utilisez votre compte Discord pour créer votre portefeuille."},{icon: <Activity />, title: "2. Analysez", desc: "Suivez les courbes en temps réel des actifs."},{icon: <Trophy />, title: "3. Dominez", desc: "Achetez bas, vendez haut et grimpez dans le classement mondial."}].map((step, i) => (<div key={i} className={`text-center group reveal delay-${(i+1)*100}`}><div className="w-20 h-20 mx-auto bg-gray-100 dark:bg-dark-800 rounded-2xl flex items-center justify-center text-gold-500 text-3xl mb-6 group-hover:scale-110 transition-transform shadow-lg">{step.icon}</div><h3 className="text-xl font-bold mb-3 dark:text-white text-dark-900">{step.title}</h3><p className="text-gray-500 text-sm leading-relaxed">{step.desc}</p></div>))}</div></div>
                    </section>
                    <footer className="mt-auto py-6 bg-dark-900 text-center relative z-10 border-t border-dark-800"><button onClick={() => setActivePage('ADMIN_LOGIN')} className="text-xs text-dark-700 hover:text-rose-500 transition-colors">Admin Access</button><div className="text-gray-600 text-xs mt-2">&copy; 2025 XALUXA AGENCY.</div></footer>
                </div>
            );
        };

        const About = () => <div className="pt-20 text-center dark:text-white">A propos (Coming Soon)</div>;
        const Features = () => <div className="pt-20 text-center dark:text-white">Fonctionnalités (Coming Soon)</div>;

        const WalletPage = () => {
            const { user, market, getPortfolioValue, transactions } = useMarket();
            const [actionMsg, setActionMsg] = useState(null);
            useScrollReveal();
            if (!user) return <div className="p-10 text-center dark:text-white">Veuillez vous connecter.</div>;
            const netWorth = getPortfolioValue();
            const cash = user.wallet.cash;
            const COLORS = ['#f59e0b', '#3b82f6', '#10b981', '#94a3b8'];
            const assetData = Object.entries(user.wallet.assets).map(([symbol, qty], index) => { const asset = market.find(m => m.symbol === symbol); const value = qty * (asset ? asset.price : 0); return { name: symbol, value: value, color: COLORS[index % COLORS.length] }; }).filter(d => d.value > 1);
            assetData.unshift({ name: 'Cash', value: cash, color: '#10b981' });
            const handleSimulateAction = (type) => { setActionMsg({ type, msg: "Fonctionnalité de démonstration. Utilisez le panneau Admin pour modifier les fonds réels." }); setTimeout(() => setActionMsg(null), 4000); };

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-dark-950 transition-theme pb-20 relative pt-20">
                    <NavBar />
                    <div className="container mx-auto px-4 md:px-6 py-8">
                        <h1 className="text-3xl font-bold mb-8 dark:text-white text-dark-900 reveal">Mon Portefeuille</h1>
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                            <div className="lg:col-span-2 bg-white dark:bg-dark-800 rounded-2xl p-6 shadow-xl border dark:border-dark-700 reveal delay-100 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-10 opacity-5 pointer-events-none"><Wallet size={200} className="text-gold-500" /></div>
                                <div className="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6"><div><p className="text-gray-500 uppercase tracking-widest text-xs font-bold mb-2">Valeur Totale Estimée</p><h2 className="text-4xl md:text-5xl font-black dark:text-white text-dark-900 mb-2">${netWorth.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h2><div className="flex gap-4 text-sm"><span className="text-emerald-500 font-bold bg-emerald-500/10 px-2 py-1 rounded">Cash: ${cash.toLocaleString(undefined, {maximumFractionDigits: 0})}</span><span className="text-blue-500 font-bold bg-blue-500/10 px-2 py-1 rounded">Actifs: ${(netWorth - cash).toLocaleString(undefined, {maximumFractionDigits: 0})}</span></div></div><div className="flex gap-3"><button onClick={() => handleSimulateAction('DEPOSIT')} className="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg btn-hover flex items-center gap-2"><PlusCircle size={18} /> Dépôt</button><button onClick={() => handleSimulateAction('WITHDRAW')} className="bg-dark-700 hover:bg-dark-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg btn-hover flex items-center gap-2"><Minus size={18} /> Retrait</button></div></div>
                                {actionMsg && ( <div className="mt-4 p-3 bg-gray-100 dark:bg-dark-900 rounded-lg text-xs text-center text-gray-500 border border-gray-200 dark:border-dark-700 animate-fade-in">{actionMsg.msg}</div> )}
                            </div>
                            <div className="bg-white dark:bg-dark-800 rounded-2xl p-6 shadow-xl border dark:border-dark-700 reveal delay-200 flex flex-col items-center justify-center min-h-[300px]"><h3 className="text-lg font-bold mb-4 dark:text-gray-200 w-full text-left">Répartition</h3><ResponsiveContainer width="100%" height={250}><PieChart><Pie data={assetData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">{assetData.map((entry, index) => ( <Cell key={`cell-${index}`} fill={entry.color} stroke="none" /> ))}</Pie><Tooltip contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', borderRadius: '8px', color: '#fff' }} itemStyle={{ color: '#fff' }} formatter={(value) => `$${value.toLocaleString(undefined, {maximumFractionDigits: 0})}`} /></PieChart></ResponsiveContainer></div>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div className="bg-white dark:bg-dark-800 rounded-2xl p-6 shadow-xl border dark:border-dark-700 reveal delay-300"><h3 className="text-lg font-bold mb-4 dark:text-gray-200 flex items-center gap-2"><Layers size={18} className="text-gold-500"/> Mes Actifs</h3><div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="text-xs text-gray-500 uppercase border-b dark:border-dark-700"><tr><th className="py-3">Actif</th><th className="py-3 text-right">Quantité</th><th className="py-3 text-right">Prix Actuel</th><th className="py-3 text-right">Valeur</th></tr></thead><tbody className="dark:text-gray-300">{Object.entries(user.wallet.assets).map(([symbol, qty]) => { const mData = market.find(m => m.symbol === symbol); const val = qty * (mData ? mData.price : 0); if (!mData) return null; return ( <tr key={symbol} className="border-b dark:border-dark-700 last:border-0 hover:bg-gray-50 dark:hover:bg-dark-700 transition-colors"><td className="py-3 font-bold">{symbol}</td><td className="py-3 text-right font-mono">{qty.toLocaleString(undefined, {minimumFractionDigits: 4, maximumFractionDigits: 8})}</td><td className="py-3 text-right text-gray-500">${mData?.price.toLocaleString()}</td><td className="py-3 text-right font-bold text-emerald-500">${val.toLocaleString(undefined, {maximumFractionDigits: 2})}</td></tr> ); })}{Object.values(user.wallet.assets).every(q => q === 0) && ( <tr><td colSpan="4" className="py-4 text-center text-gray-500 italic">Aucun actif détenu.</td></tr> )}</tbody></table></div></div>
                            <div className="bg-white dark:bg-dark-800 rounded-2xl p-6 shadow-xl border dark:border-dark-700 reveal delay-300"><h3 className="text-lg font-bold mb-4 dark:text-gray-200 flex items-center gap-2"><Clock size={18} className="text-blue-500"/> Derniers Mouvements</h3><div className="space-y-3 max-h-[300px] overflow-y-auto pr-2">{transactions.length === 0 ? ( <div className="text-center text-gray-500 italic py-8">Aucune transaction.</div> ) : ( transactions.map((t, i) => ( <div key={i} className="flex justify-between items-center p-3 bg-gray-50 dark:bg-dark-900 rounded-lg border border-transparent hover:border-gray-200 dark:hover:border-dark-600 transition-all"><div className="flex items-center gap-3"><div className={`p-2 rounded-full ${t.type.includes('BUY') ? 'bg-emerald-500/10 text-emerald-500' : t.type.includes('SELL') ? 'bg-rose-500/10 text-rose-500' : 'bg-blue-500/10 text-blue-500'}`}>{t.type.includes('BUY') ? <Plus size={14}/> : t.type.includes('SELL') ? <Minus size={14}/> : <Send size={14}/>}</div><div><div className="font-bold dark:text-white text-xs">{t.type} {t.symbol}</div><div className="text-[10px] text-gray-500">{t.time}</div></div></div><div className="text-right"><div className="font-mono font-bold dark:text-gray-200 text-sm">{typeof t.qty === 'number' ? t.qty.toFixed(4) : t.qty}</div><div className="text-[10px] text-gray-500">@ ${t.price.toLocaleString()}</div></div></div> )) )}</div></div>
                        </div>
                    </div>
                </div>
            );
        };

        const TransferPage = () => {
            const { user, transferCash, setActivePage, isChristmas } = useMarket();
            const [dest, setDest] = useState('');
            const [amount, setAmount] = useState('');
            const [msg, setMsg] = useState(null);

            if (!user) return (
                <div className="min-h-screen flex items-center justify-center dark:bg-dark-950 bg-gray-50 flex-col gap-6 p-4 animate-fade-in transition-theme pt-20">
                    <div className="bg-white dark:bg-dark-800 p-8 rounded-2xl shadow-xl text-center border dark:border-dark-700 max-w-sm w-full relative overflow-hidden">
                        {isChristmas ? ( <div className="absolute top-0 right-0 w-32 h-32 bg-christmas-red rounded-full blur-[60px] opacity-20"></div> ) : ( <div className="absolute top-0 right-0 w-32 h-32 bg-gold-500 rounded-full blur-[60px] opacity-10"></div> )}
                        <ShieldAlert size={48} className={`${isChristmas ? 'text-christmas-red' : 'text-gold-500'} mx-auto mb-4 relative z-10`} />
                        <h2 className="text-xl font-bold dark:text-white text-dark-900 mb-2 relative z-10">Accès Restreint</h2>
                        <p className="text-gray-500 mb-8 text-sm relative z-10">Veuillez vous connecter pour accéder aux virements.</p>
                        <button onClick={() => setActivePage('HOME')} className={`w-full text-white py-3.5 rounded-xl font-bold hover:scale-[1.02] transition-transform shadow-lg relative z-10 btn-hover ${isChristmas ? 'bg-gradient-to-r from-christmas-red to-christmas-green' : 'bg-dark-900 dark:bg-white dark:text-dark-900'}`}>Retour à l'accueil</button>
                    </div>
                </div>
            );

            const isPremium = isUserPremium(user);
            const fees = isPremium ? 0 : FEES.TRANSFER * 100;
            const handleTransfer = (e) => { e.preventDefault(); const val = parseFloat(amount); if(!dest || isNaN(val)) return; const res = transferCash(dest, val); setMsg(res); if(res.s) { setAmount(''); setDest(''); } };

            return (
                <div className="min-h-screen dark:bg-dark-950 bg-gray-50 transition-theme pt-20">
                    <NavBar />
                    <div className="container mx-auto px-6 py-12 flex justify-center">
                        <div className="w-full max-w-lg bg-white dark:bg-dark-800 rounded-2xl p-8 shadow-2xl border dark:border-dark-700 border-light-200">
                            <h1 className="text-3xl font-bold mb-6 flex items-center gap-3 dark:text-white text-dark-900"><Send className="text-gold-500" /> Virement Sécurisé</h1>
                            <form onSubmit={handleTransfer} className="space-y-6">
                                <div><label className="block text-sm font-bold text-gray-500 mb-2">ID Destinataire (Interne)</label><input type="text" value={dest} onChange={e => setDest(e.target.value)} className="w-full bg-gray-100 dark:bg-dark-900 p-4 rounded-lg outline-none focus:ring-2 ring-gold-500 dark:text-white" placeholder="Ex: XID-1234-5678" /></div>
                                <div><label className="block text-sm font-bold text-gray-500 mb-2">Montant ($)</label><input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="w-full bg-gray-100 dark:bg-dark-900 p-4 rounded-lg outline-none focus:ring-2 ring-gold-500 dark:text-white" placeholder="0.00" /><p className="text-xs text-gray-400 mt-2 italic">* {isPremium ? <span className="text-gold-500 font-bold">0% de frais (Premium)</span> : <span className="text-rose-500 font-bold">{fees}% de frais</span>}</p></div>
                                <button type="submit" className="w-full bg-gold-500 hover:bg-gold-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg btn-hover">Confirmer</button>
                                {msg && ( <div className={`p-4 rounded-xl text-center font-bold ${msg.s ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>{msg.m}</div> )}
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        const ReferralPage = () => {
            const { user, applyReferralCode, claimReferralEarnings, allUsers, generateMyReferralCode, setActivePage, isChristmas } = useMarket();
            const [code, setCode] = useState('');
            const [msg, setMsg] = useState(null);
            const [genError, setGenError] = useState(null);
            useScrollReveal();

            if (!user) return (
                <div className="min-h-screen flex items-center justify-center dark:bg-dark-950 bg-gray-50 flex-col gap-6 p-4 animate-fade-in transition-theme pt-20">
                    <div className="bg-white dark:bg-dark-800 p-8 rounded-2xl shadow-xl text-center border dark:border-dark-700 max-w-sm w-full relative overflow-hidden">
                        {isChristmas ? ( <div className="absolute top-0 right-0 w-32 h-32 bg-christmas-red rounded-full blur-[60px] opacity-20"></div> ) : ( <div className="absolute top-0 right-0 w-32 h-32 bg-gold-500 rounded-full blur-[60px] opacity-10"></div> )}
                        <ShieldAlert size={48} className={`${isChristmas ? 'text-christmas-red' : 'text-gold-500'} mx-auto mb-4 relative z-10`} />
                        <h2 className="text-xl font-bold dark:text-white text-dark-900 mb-2 relative z-10">Accès Restreint</h2>
                        <p className="text-gray-500 mb-8 text-sm relative z-10">Veuillez vous connecter pour accéder au programme d'affiliation.</p>
                        <button onClick={() => setActivePage('HOME')} className={`w-full text-white py-3.5 rounded-xl font-bold hover:scale-[1.02] transition-transform shadow-lg relative z-10 btn-hover ${isChristmas ? 'bg-gradient-to-r from-christmas-red to-christmas-green' : 'bg-dark-900 dark:bg-white dark:text-dark-900'}`}>Retour à l'accueil</button>
                    </div>
                </div>
            );

            const myAffiliates = allUsers.filter(u => u.referredBy === user.id);
            const totalAffiliates = myAffiliates.length;

            useEffect(() => { if (!user.referralCode) { const res = generateMyReferralCode(); if (res && !res.s) { setGenError(res.m); } } }, [user.referralCode]);
            const handleApply = () => { if(!code) return; const res = applyReferralCode(code); setMsg(res); if(res.s) setCode(''); };
            const handleClaim = () => { const res = claimReferralEarnings(); setMsg(res); };
            const copyToClipboard = () => { if (!user.referralCode) return; navigator.clipboard.writeText(user.referralCode); setMsg({s:true, m:"Code copié !"}); setTimeout(() => setMsg(null), 2000); }

            const StatsCard = ({ title, value, color, icon }) => (
                <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl border dark:border-dark-700 shadow-xl relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300 reveal">
                    <div className={`absolute top-0 right-0 p-4 opacity-10 ${color}`}>{React.cloneElement(icon, { size: 60 })}</div>
                    <div className="relative z-10"><div className="text-gray-500 text-xs uppercase font-bold tracking-widest mb-2">{title}</div><div className={`text-3xl font-black ${color.replace('bg-', 'text-').replace('/10', '')}`}>{value}</div></div>
                </div>
            );

            return (
                <div className="min-h-screen dark:bg-dark-950 bg-gray-50 transition-theme pt-20 pb-20">
                    <NavBar />
                    <div className="container mx-auto px-6 py-8">
                        <div className="text-center mb-16 animate-scale-in"><span className="text-gold-500 font-bold tracking-widest uppercase text-xs bg-gold-500/10 px-3 py-1 rounded-full mb-4 inline-block">Programme Ambassadeur</span><h1 className="text-4xl md:text-5xl font-black dark:text-white text-dark-900 mb-4">Affiliation & Récompenses</h1><p className="text-gray-500 max-w-2xl mx-auto">Invitez vos amis à rejoindre. Gagnez des commissions à vie.</p></div>
                        <div className="grid lg:grid-cols-12 gap-8 mb-16">
                            <div className="lg:col-span-7 space-y-6">
                                <div className="bg-gradient-to-br from-gray-900 to-black rounded-3xl p-8 text-white shadow-2xl relative overflow-hidden border border-gray-800 h-64 flex flex-col justify-between group reveal">
                                    <div className="absolute top-0 right-0 w-64 h-64 bg-gold-500 rounded-full blur-[100px] opacity-20 group-hover:opacity-30 transition-opacity duration-500"></div>
                                    <div className="relative z-10 flex justify-between items-start"><div><div className="text-gold-400 uppercase text-xs font-bold tracking-[0.2em] mb-1">Wallet Parrainage</div><div className="text-5xl font-mono font-bold tracking-tighter">${(user.referralWallet || 0).toFixed(2)}</div></div><div className="bg-white/10 p-2 rounded-lg backdrop-blur-md"><Activity className="text-gold-400" /></div></div>
                                    <div className="relative z-10"><button onClick={handleClaim} className="w-full bg-gold-500 hover:bg-gold-400 text-black py-4 rounded-xl font-bold transition-all shadow-lg hover:shadow-gold-500/20 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 btn-hover" disabled={(user.referralWallet || 0) <= 0}><Gift size={20}/> Récupérer mes gains</button></div>
                                </div>
                                <div className="grid grid-cols-2 gap-4"><StatsCard title="Filleuls Actifs" value={totalAffiliates} color="text-blue-500" icon={<Users />} /><StatsCard title="Gains Totaux" value={`$${(user.totalReferralEarnings || 0).toFixed(2)}`} color="text-emerald-500" icon={<Coins />} /></div>
                            </div>
                            <div className="lg:col-span-5 space-y-6">
                                <div className="bg-white dark:bg-dark-800 p-8 rounded-3xl border dark:border-dark-700 shadow-xl relative overflow-hidden reveal delay-100">
                                     <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-gold-500 to-purple-500"></div>
                                     <h3 className="text-xl font-bold dark:text-white mb-6 flex items-center gap-2"><LinkIcon className="text-gold-500"/> Votre Lien Unique</h3>
                                     {genError ? ( <div className="p-4 bg-rose-100 text-rose-700 rounded-xl font-bold text-center border border-rose-200"><ShieldAlert className="inline mb-1 mr-2"/>{genError}</div> ) : user.referralCode ? ( <div className="space-y-4"><div className="bg-gray-50 dark:bg-dark-900 p-4 rounded-2xl border-2 border-dashed border-gray-200 dark:border-dark-700 flex justify-between items-center group hover:border-gold-500 transition-colors cursor-pointer" onClick={copyToClipboard}><span className="font-mono text-2xl font-bold text-gray-700 dark:text-gray-200 tracking-wider">{user.referralCode}</span><span className="bg-gold-500/10 text-gold-600 p-2 rounded-lg group-hover:bg-gold-500 group-hover:text-white transition-all"><LinkIcon size={20}/></span></div><p className="text-xs text-gray-400 text-center">Partagez ce code. Vous gagnez 1% de chaque transfert sortant de vos filleuls.</p></div> ) : ( <div className="text-center py-4 text-gray-400 italic">Génération en cours...</div> )}
                                </div>
                                <div className="bg-gray-50 dark:bg-dark-900 p-8 rounded-3xl border dark:border-dark-700 shadow-inner reveal delay-200">
                                    <h3 className="text-lg font-bold dark:text-white mb-4 flex items-center gap-2"><PlusCircle className="text-purple-500"/> Rejoindre un parrain</h3>
                                    {user.referredBy ? ( <div className="bg-emerald-500/10 border border-emerald-500/20 p-4 rounded-xl flex items-center gap-3"><div className="bg-emerald-500 text-white rounded-full p-2"><CheckCircle size={20}/></div><div><div className="font-bold text-emerald-500 text-sm">Compte lié avec succès</div><div className="text-xs text-emerald-600/70">{user.referredBy === 'SYSTEM_CRYPTO10' ? 'Code Promo CRYPTO10' : `Parrain: ${user.referredBy.substring(0,8)}...`}</div></div></div> ) : ( <div className="space-y-3"><div className="relative"><input type="text" placeholder="Code Parrain" className="w-full bg-white dark:bg-dark-800 p-4 pl-12 rounded-xl outline-none focus:ring-2 ring-purple-500 dark:text-white font-bold uppercase tracking-wider shadow-sm transition-all" value={code} onChange={e => setCode(e.target.value)} /><Users className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={20}/></div><button onClick={handleApply} className="w-full bg-dark-900 dark:bg-white dark:text-dark-900 text-white py-4 rounded-xl font-bold shadow-lg hover:scale-[1.02] transition-transform btn-hover">Valider le code</button><p className="text-xs text-center text-gray-400">Bonus de bienvenue : <span className="text-gold-500 font-bold">$100 offerts</span></p></div> )}
                                    {msg && ( <div className={`mt-4 p-3 rounded-xl text-center text-sm font-bold animate-fade-in ${msg.s ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>{msg.m}</div> )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminLogin = () => {
            const { adminLogin, setActivePage } = useMarket();
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [err, setErr] = useState(false);
            const sub = (e) => { e.preventDefault(); if(adminLogin(u, p)) setActivePage('ADMIN_DASHBOARD'); else setErr(true); };
            return (
                <div className="min-h-screen bg-dark-950 flex items-center justify-center p-4">
                    <div className="w-full max-w-md bg-dark-800 p-8 rounded-2xl border border-dark-700 shadow-2xl">
                        <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2"><Lock className="text-rose-500"/> Administration</h2>
                        <form onSubmit={sub} className="space-y-4">
                            <input type="text" placeholder="Pseudo" className="w-full bg-dark-900 p-3 rounded text-white border border-dark-700" value={u} onChange={e=>setU(e.target.value)} />
                            <input type="password" placeholder="Mot de passe" className="w-full bg-dark-900 p-3 rounded text-white border border-dark-700" value={p} onChange={e=>setP(e.target.value)} />
                            {err && <p className="text-rose-500 text-sm">Erreur d'identifiants.</p>}
                            <button className="w-full bg-rose-600 hover:bg-rose-700 text-white py-3 rounded font-bold btn-hover">Connexion</button>
                        </form>
                        <button onClick={() => setActivePage('HOME')} className="mt-4 text-gray-500 text-sm hover:text-white w-full">Retour site</button>
                    </div>
                </div>
            );
        };

        const AdminDashboard = () => {
            const { isAdmin, allUsers, setActivePage, manageUserMoney, adminLogs, manageMarketAsset, market, manageUserPremium } = useMarket();
            const [activeTab, setActiveTab] = useState('USERS');
            const [search, setSearch] = useState('');
            const [modal, setModal] = useState({ open: false, type: 'ADD', user: null });
            const [premiumModal, setPremiumModal] = useState({ open: false, user: null, duration: 1 });
            const [amount, setAmount] = useState('');
            const [reason, setReason] = useState('');
            const [msg, setMsg] = useState(null);
            const [assetForm, setAssetForm] = useState({ symbol: '', name: '', price: '' });

            if(!isAdmin) { setTimeout(() => setActivePage('ADMIN_LOGIN'), 0); return null; }
            const filteredUsers = allUsers.filter(u => (u.discord?.username || '').toLowerCase().includes(search.toLowerCase()) || u.id.includes(search));
            
            const openModal = (type, user) => { setModal({ open: true, type, user }); setAmount(''); setReason(''); setMsg(null); };
            const openPremiumModal = (user) => { setPremiumModal({ open: true, user, duration: 1 }); setMsg(null); };

            const handleTransaction = (e) => { e.preventDefault(); const val = parseFloat(amount); if (isNaN(val) || val <= 0) return setMsg({s:false, m:"Montant invalide"}); if (!reason) return setMsg({s:false, m:"Motif requis"}); const res = manageUserMoney(modal.user.id, val, modal.type, reason); setMsg(res); if (res.s) { setTimeout(() => setModal({...modal, open: false}), 1500); } };
            const handlePremiumSubmit = (e) => { e.preventDefault(); const res = manageUserPremium(premiumModal.user.id, premiumModal.duration); setMsg(res); if (res.s) { setTimeout(() => setPremiumModal({...premiumModal, open: false}), 1500); } };
            const handleAssetSubmit = () => { manageMarketAsset('ADD', { ...assetForm, price: parseFloat(assetForm.price) }); setAssetForm({ symbol: '', name: '', price: '' }); };

            return (
                <div className="min-h-screen bg-gray-100 dark:bg-dark-950 transition-theme p-4 md:p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <h1 className="text-3xl font-bold dark:text-white text-dark-900 flex items-center gap-3"><ShieldAlert className="text-rose-500"/> Panel Admin</h1>
                            <div className="flex gap-4"><button onClick={() => setActivePage('HOME')} className="bg-dark-800 text-white px-4 py-2 rounded hover:bg-dark-700 transition btn-hover">Quitter</button></div>
                        </div>
                        <div className="flex space-x-4 border-b border-gray-300 dark:border-dark-700 mb-6">
                            <button onClick={() => setActiveTab('USERS')} className={`py-2 px-4 font-bold border-b-2 transition-colors ${activeTab === 'USERS' ? 'border-rose-500 text-rose-500' : 'border-transparent text-gray-500 hover:text-gray-700'}`}><Users size={18} className="inline mr-2"/> Utilisateurs</button>
                            <button onClick={() => setActiveTab('LOGS')} className={`py-2 px-4 font-bold border-b-2 transition-colors ${activeTab === 'LOGS' ? 'border-blue-500 text-blue-500' : 'border-transparent text-gray-500 hover:text-gray-700'}`}><FileText size={18} className="inline mr-2"/> Logs</button>
                            <button onClick={() => setActiveTab('MARKET')} className={`py-2 px-4 font-bold border-b-2 transition-colors ${activeTab === 'MARKET' ? 'border-purple-500 text-purple-500' : 'border-transparent text-gray-500 hover:text-gray-700'}`}><Activity size={18} className="inline mr-2"/> Marché</button>
                        </div>
                        {activeTab === 'USERS' && (
                            <div className="bg-white dark:bg-dark-800 rounded-xl shadow-xl border dark:border-dark-700 border-gray-200 p-6 animate-fade-in">
                                <div className="mb-4"><input type="text" placeholder="Rechercher..." className="w-full md:w-1/3 bg-gray-100 dark:bg-dark-900 p-3 rounded-lg border border-transparent focus:border-rose-500 outline-none dark:text-white" value={search} onChange={e => setSearch(e.target.value)}/></div>
                                <div className="overflow-x-auto"><table className="w-full text-left text-sm text-gray-500 dark:text-gray-400"><thead className="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-dark-900 dark:text-gray-400"><tr><th className="px-6 py-3">Utilisateur</th><th className="px-6 py-3">Solde</th><th className="px-6 py-3">Status</th><th className="px-6 py-3 text-right">Actions</th></tr></thead><tbody>{filteredUsers.map((u, i) => ( <tr key={i} className="border-b dark:border-dark-700 hover:bg-gray-50 dark:hover:bg-dark-700 transition-colors"><td className="px-6 py-4 flex items-center gap-3"><img src={u.discord?.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png'} className="w-10 h-10 rounded-full" /><div><div className="font-bold dark:text-white text-base">{u.discord?.username || 'Unknown'}</div><div className="text-xs text-gray-500 font-mono">{u.id}</div></div></td><td className="px-6 py-4"><span className="font-mono text-emerald-500 font-bold text-lg">${u.wallet.cash.toLocaleString()}</span></td><td className="px-6 py-4">{isUserPremium(u) ? <span className="text-gold-500 font-bold flex items-center gap-1"><Crown size={14}/> Premium</span> : <span className="text-gray-500">Standard</span>}</td><td className="px-6 py-4 text-right space-x-2"><button onClick={() => openModal('ADD', u)} className="bg-emerald-500 hover:bg-emerald-600 text-white p-2 rounded-lg shadow transition btn-hover"><Plus size={16}/></button><button onClick={() => openModal('REMOVE', u)} className="bg-rose-500 hover:bg-rose-600 text-white p-2 rounded-lg shadow transition btn-hover"><Minus size={16}/></button><button onClick={() => openPremiumModal(u)} className="bg-gold-500 hover:bg-gold-600 text-white p-2 rounded-lg shadow transition btn-hover" title="Gérer Premium"><Crown size={16}/></button></td></tr> ))}</tbody></table></div>
                            </div>
                        )}
                        {activeTab === 'LOGS' && ( <div className="bg-white dark:bg-dark-800 rounded-xl shadow-xl border dark:border-dark-700 border-gray-200 p-6 animate-fade-in"><div className="overflow-x-auto"><table className="w-full text-left text-sm text-gray-500 dark:text-gray-400"><thead className="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-dark-900 dark:text-gray-400"><tr><th className="px-6 py-3">Date</th><th className="px-6 py-3">Action</th><th className="px-6 py-3">Cible</th><th className="px-6 py-3">Montant</th></tr></thead><tbody>{adminLogs.map((log, i) => (<tr key={i} className="border-b dark:border-dark-700 hover:bg-gray-50 dark:hover:bg-dark-700"><td className="px-6 py-4">{log.timestamp}</td><td className="px-6 py-4"><span className={`px-2 py-1 rounded text-xs font-bold ${log.action === 'ADD' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>{log.action}</span></td><td className="px-6 py-4 dark:text-white">{log.targetUsername}</td><td className="px-6 py-4 font-mono font-bold">${log.amount.toLocaleString()}</td></tr>))}</tbody></table></div></div> )}
                        {activeTab === 'MARKET' && ( <div className="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-xl border dark:border-dark-700 border-gray-200 animate-fade-in"><div className="flex gap-4 mb-6"><input placeholder="Symbole (BTC)" value={assetForm.symbol} onChange={e=>setAssetForm({...assetForm, symbol:e.target.value})} className="bg-gray-100 dark:bg-dark-900 p-2 rounded dark:text-white w-24" /><input placeholder="Nom" value={assetForm.name} onChange={e=>setAssetForm({...assetForm, name:e.target.value})} className="bg-gray-100 dark:bg-dark-900 p-2 rounded dark:text-white flex-1" /><input placeholder="Prix" type="number" value={assetForm.price} onChange={e=>setAssetForm({...assetForm, price:e.target.value})} className="bg-gray-100 dark:bg-dark-900 p-2 rounded dark:text-white w-32" /><button onClick={handleAssetSubmit} className="bg-emerald-500 text-white px-4 rounded font-bold hover:bg-emerald-600 transition">Ajouter</button></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{market.map(m => ( <div key={m.symbol} className="p-4 border dark:border-dark-700 rounded-lg flex justify-between items-center dark:text-white bg-gray-50 dark:bg-dark-900"><div><span className="font-bold">{m.name}</span> <span className="text-xs text-gray-500">({m.symbol})</span></div><div className="flex gap-2"><button onClick={()=>manageMarketAsset('TOGGLE', m.symbol)} className={`text-xs px-2 py-1 rounded font-bold ${m.active?'bg-emerald-500 text-white':'bg-gray-500 text-white'}`}>{m.active?'ON':'OFF'}</button><button onClick={()=>manageMarketAsset('DELETE', m.symbol)} className="text-rose-500 hover:bg-rose-500/10 p-1 rounded"><Trash size={16}/></button></div></div> ))}</div></div> )}
                    </div>
                    {modal.open && ( <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fade-in"><div className="bg-white dark:bg-dark-800 rounded-xl p-6 w-full max-w-sm shadow-2xl relative animate-scale-in border dark:border-dark-700"><h3 className="text-xl font-bold mb-4 dark:text-white">{modal.type === 'ADD' ? 'Ajouter' : 'Retirer'} Argent</h3><form onSubmit={handleTransaction} className="space-y-4"><input type="number" className="w-full bg-gray-100 dark:bg-dark-900 p-3 rounded-lg dark:text-white" placeholder="Montant" value={amount} onChange={e => setAmount(e.target.value)} autoFocus /><input type="text" className="w-full bg-gray-100 dark:bg-dark-900 p-3 rounded-lg dark:text-white" placeholder="Motif" value={reason} onChange={e => setReason(e.target.value)} /><div className="grid grid-cols-2 gap-3"><button type="button" onClick={() => setModal({...modal, open: false})} className="px-4 py-2 rounded-lg bg-gray-200 dark:bg-dark-700 dark:text-white font-bold">Annuler</button><button className="px-4 py-2 rounded-lg bg-emerald-500 text-white font-bold">Confirmer</button></div></form></div></div> )}
                    {premiumModal.open && ( <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fade-in"><div className="bg-white dark:bg-dark-800 rounded-xl p-6 w-full max-w-sm shadow-2xl relative animate-scale-in border dark:border-dark-700"><h3 className="text-xl font-bold mb-4 dark:text-white flex items-center gap-2"><Crown className="text-gold-500"/> Gestion Premium</h3><form onSubmit={handlePremiumSubmit} className="space-y-4"><div className="dark:text-white mb-2 font-bold">{premiumModal.user.discord?.username}</div><div className="space-y-2"><label className="block text-sm dark:text-gray-400">Durée</label><select className="w-full bg-gray-100 dark:bg-dark-900 p-3 rounded-lg dark:text-white border border-transparent focus:border-gold-500 outline-none" value={premiumModal.duration} onChange={e => setPremiumModal({...premiumModal, duration: e.target.value})}><option value={1}>1 Mois</option><option value={3}>3 Mois</option><option value={6}>6 Mois</option></select></div><div className="grid grid-cols-2 gap-3 mt-4"><button type="button" onClick={() => setPremiumModal({...premiumModal, open: false})} className="px-4 py-2 rounded-lg bg-gray-200 dark:bg-dark-700 dark:text-white font-bold">Annuler</button><button className="px-4 py-2 rounded-lg bg-gold-500 text-white font-bold">Activer</button></div></form>{msg && <div className={`mt-2 p-2 rounded text-center text-sm font-bold ${msg.s ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>{msg.m}</div>}</div></div> )}
                </div>
            );
        };

        const PageTransition = ({ children }) => (
            <div className="animate-fade-in w-full">
                {children}
            </div>
        );

        const App = () => {
            const { activePage, isChristmas } = useMarket();
            let Content;
            switch(activePage) {
                case 'DASHBOARD': Content = <Dashboard />; break;
                case 'WALLET': Content = <WalletPage />; break;
                case 'ABOUT': Content = <About />; break;
                case 'FEATURES': Content = <Features />; break;
                case 'TRANSFER': Content = <TransferPage />; break;
                case 'REFERRAL': Content = <ReferralPage />; break;
                case 'ADMIN_LOGIN': Content = <AdminLogin />; break;
                case 'ADMIN_DASHBOARD': Content = <AdminDashboard />; break;
                default: Content = <Home />;
            }
            
            return (
                <>
                <SnowEffect enabled={isChristmas} />
                <AdminAccessButton />
                <DemoAccessButton />
                <NotificationContainer />
                <PageTransition key={activePage}>
                    {Content}
                </PageTransition>
                </>
            );
        };

        const Root = () => (
            <MarketProvider>
                <App />
            </MarketProvider>
        );

        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
