<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XALUXA AGENCY | Trade & Dominate</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class', // Enable class-based dark mode
        theme: {
          extend: {
            colors: {
              discord: {
                blue: '#5865F2',
                gray: '#36393f',
              },
              steam: {
                dark: '#171a21',
                blue: '#66c0f4',
              },
              gold: {
                400: '#fbbf24',
                500: '#f59e0b',
                600: '#d97706',
              },
              dark: {
                950: '#020617', // Main bg dark
                900: '#0f172a', // Secondary bg dark
                800: '#1e293b', // Card bg dark
                700: '#334155', // Border dark
              },
              light: {
                50: '#f8fafc', // Main bg light
                100: '#f1f5f9', // Secondary bg light
                200: '#e2e8f0', // Card bg light
                300: '#cbd5e1', // Border light
              }
            },
            animation: {
              'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'spin-slow': 'spin 3s linear infinite',
              'fade-in': 'fadeIn 0.3s ease-out',
              'slide-up': 'slideUp 0.4s ease-out',
            },
            keyframes: {
                fadeIn: {
                    '0%': { opacity: '0' },
                    '100%': { opacity: '1' },
                },
                slideUp: {
                    '0%': { transform: 'translateY(20px)', opacity: '0' },
                    '100%': { transform: 'translateY(0)', opacity: '1' },
                }
            }
          },
        },
      }
    </script>

    <!-- React & ReactDOM (UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Prop Types -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <style>
      /* Smooth transitions for theme switching */
      body {
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      .transition-theme {
        transition-property: background-color, border-color, color, fill, stroke;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 300ms;
      }
      
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent; 
      }
      ::-webkit-scrollbar-thumb {
        background: #475569; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #64748b; 
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. GLOBALS & IMPORTS ---
        const { useState, useEffect, createContext, useContext, useMemo } = React;
        const RechartsObj = window.Recharts;
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell } = RechartsObj || {};

        // --- 2. ICONS ---
        const Icon = ({ size = 24, className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Activity = (props) => (<Icon {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></Icon>);
        const TrendingUp = (props) => (<Icon {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></Icon>);
        const DollarSign = (props) => (<Icon {...props}><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></Icon>);
        const LogOut = (props) => (<Icon {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></Icon>);
        const Send = (props) => (<Icon {...props}><line x1="22" x2="11" y1="2" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></Icon>);
        const PlusCircle = (props) => (<Icon {...props}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="16" /><line x1="8" x2="16" y1="12" y2="12" /></Icon>);
        const Trophy = (props) => (<Icon {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M12 15a7 7 0 0 0 7-7c0-2-4-2-4-2H9c0 0-4 0-4 2a7 7 0 0 0 7 7Z" /><path d="M12 15v7" /></Icon>);
        const Coins = (props) => (<Icon {...props}><circle cx="8" cy="8" r="6" /><path d="M18.09 10.37A6 6 0 1 1 10.34 18" /><path d="M7 6h1v4" /><path d="m16.71 13.88.7.71-2.82 2.82" /></Icon>);
        const Sun = (props) => (<Icon {...props}><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></Icon>);
        const Moon = (props) => (<Icon {...props}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" /></Icon>);
        const HomeIcon = (props) => (<Icon {...props}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></Icon>);
        const X = (props) => (<Icon {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></Icon>);
        const Briefcase = (props) => (<Icon {...props}><rect x="2" y="7" width="20" height="14" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></Icon>);
        const Layers = (props) => (<Icon {...props}><polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 17 12 22 22 17" /><polyline points="2 12 12 17 22 12" /></Icon>);
        const Newspaper = (props) => (<Icon {...props}><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8V6Z"/></Icon>);
        const Clock = (props) => (<Icon {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>);
        const Lock = (props) => (<Icon {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></Icon>);
        const ShieldAlert = (props) => (<Icon {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></Icon>);
        const Users = (props) => (<Icon {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>);
        const CheckCircle = (props) => (<Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>);
        const LinkIcon = (props) => (<Icon {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></Icon>);

        const SteamIcon = () => (<i className="fa-brands fa-steam text-xl"></i>);

        // --- 3. CONSTANTS ---
        const CryptoSymbol = { ATERIS: 'ATERIS', BALIEM: 'BALIEM', BASTRUM: 'BASTRUM', UDC: 'UDC' };
        const INITIAL_MARKET_DATA = [
            { symbol: CryptoSymbol.ATERIS, name: 'Ateris', price: 72500, change24h: 2.5, history: [], color: '#f59e0b' },
            { symbol: CryptoSymbol.BALIEM, name: 'Baliem', price: 24000, change24h: -1.2, history: [], color: '#3b82f6' },
            { symbol: CryptoSymbol.BASTRUM, name: 'Bastrum', price: 2500, change24h: 15.4, history: [], color: '#10b981' },
            { symbol: CryptoSymbol.UDC, name: 'UDC', price: 1, change24h: 0, history: [], color: '#94a3b8' },
        ];
        
        const SPECIAL_CODES = {
            CRYPTO10: 'SYSTEM_CRYPTO10'
        };

        // --- 4. ENGINE ---
        const randomRange = (min, max) => Math.random() * (max - min) + min;
        const simulateMarketUpdate = (currentMarket) => {
            return currentMarket.map((asset) => {
                if (asset.symbol === CryptoSymbol.UDC) return asset;
                const change = (Math.random() - 0.5) * 0.04 * asset.price;
                let newPrice = asset.price + change;
                if (newPrice < 0.1) newPrice = 0.1;
                const newHistory = [...asset.history, { time: new Date().toLocaleTimeString(), price: newPrice }];
                if (newHistory.length > 40) newHistory.shift();
                return { ...asset, price: newPrice, history: newHistory, change24h: asset.change24h + (Math.random() - 0.5) * 0.5 };
            });
        };

        const generateReferralCode = (username) => {
            // Clean username to keep only alphanum
            const base = username.replace(/[^a-zA-Z0-9]/g, '').substring(0, 4).toUpperCase();
            const suffix = Math.floor(1000 + Math.random() * 9000); // 4 digit random
            return `${base}${suffix}`;
        };

        // --- 5. CONTEXT ---
        const MarketContext = createContext(undefined);

        const MarketProvider = ({ children }) => {
            const [market, setMarket] = useState(INITIAL_MARKET_DATA);
            // User extended: referralCode, referredBy, referralWallet (pending commissions), totalReferralEarnings (stats)
            const [user, setUser] = useState(null); 
            const [allUsers, setAllUsers] = useState([]); // "Database"
            const [transactions, setTransactions] = useState([]);
            const [activePage, setActivePage] = useState('HOME');
            const [theme, setTheme] = useState('dark');
            const [isLoading, setIsLoading] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);

            useEffect(() => {
                const savedTheme = localStorage.getItem('xaluxa_theme') || 'dark';
                setTheme(savedTheme);
                document.documentElement.className = savedTheme;
            }, []);
            const toggleTheme = () => {
                const newTheme = theme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
                localStorage.setItem('xaluxa_theme', newTheme);
                document.documentElement.className = newTheme;
            };

            useEffect(() => {
                setMarket(prev => prev.map(asset => {
                    const history = [];
                    let p = asset.price;
                    for(let i=0; i<30; i++) { p = p * (1 + (Math.random() * 0.04 - 0.02)); history.push({ time: i.toString(), price: p }); }
                    return { ...asset, history };
                }));
                const savedDb = localStorage.getItem('xaluxa_db');
                if (savedDb) setAllUsers(JSON.parse(savedDb));
                setTransactions([
                    { type: 'BUY', symbol: 'ATERIS', qty: 0.012, price: 71000, time: '10:23' },
                    { type: 'SELL', symbol: 'BASTRUM', qty: 5.4, price: 2300, time: '09:45' },
                ]);
            }, []);

            useEffect(() => {
                if(allUsers.length > 0) localStorage.setItem('xaluxa_db', JSON.stringify(allUsers));
            }, [allUsers]);

            // Auth Logic (Discord)
            useEffect(() => {
                const hash = window.location.hash;
                const savedUser = localStorage.getItem('xaluxa_user');
                if (savedUser) { setUser(JSON.parse(savedUser)); }

                if (hash && hash.includes('access_token')) {
                    setIsLoading(true);
                    const fragment = new URLSearchParams(hash.slice(1));
                    const accessToken = fragment.get('access_token');
                    if (accessToken) {
                        fetch('https://discord.com/api/users/@me', { headers: { authorization: `Bearer ${accessToken}` } })
                        .then(r => r.json())
                        .then(data => {
                            if(data.id) {
                                handleUserLogin({
                                    id: data.id,
                                    discord: {
                                        id: data.id,
                                        username: `${data.username}#${data.discriminator || '0000'}`,
                                        avatar: data.avatar ? `https://cdn.discordapp.com/avatars/${data.id}/${data.avatar}.jpg` : 'https://cdn.discordapp.com/embed/avatars/0.png'
                                    },
                                    steam: null,
                                    wallet: { cash: 5000, assets: { [CryptoSymbol.ATERIS]: 0, [CryptoSymbol.BALIEM]: 0, [CryptoSymbol.BASTRUM]: 0, [CryptoSymbol.UDC]: 0 } }
                                });
                                setActivePage('HOME');
                            }
                        }).catch(e => console.error(e)).finally(() => { setIsLoading(false); window.history.replaceState({}, document.title, window.location.pathname); });
                    }
                }
            }, []);

            const handleUserLogin = (userData) => {
                const now = new Date().toISOString();
                setUser(prev => {
                    // Check if user exists in DB to retrieve referral data
                    const existingUserInDb = allUsers.find(u => u.id === userData.id);
                    
                    let userState;
                    if (existingUserInDb) {
                        userState = { ...existingUserInDb, ...userData, lastLogin: now }; // Merge fresh auth data
                    } else {
                        // NEW USER INITIALIZATION
                        userState = { 
                            ...userData, 
                            joinedAt: now, 
                            lastLogin: now,
                            // Referral Init
                            referralCode: generateReferralCode(userData.discord.username),
                            referredBy: null, // Locked once set
                            referralWallet: 0, // Available to claim
                            totalReferralEarnings: 0 // History
                        };
                    }

                    // Update DB with this merged state
                    setAllUsers(currentDb => {
                        const idx = currentDb.findIndex(u => u.id === userState.id);
                        if(idx >= 0) {
                            const updatedDb = [...currentDb];
                            updatedDb[idx] = userState;
                            return updatedDb;
                        } else {
                            return [...currentDb, userState];
                        }
                    });
                    
                    localStorage.setItem('xaluxa_user', JSON.stringify(userState));
                    return userState;
                });
            };

            const applyReferralCode = (code) => {
                if (!user) return { s: false, m: "Non connecté" };
                if (user.referredBy) return { s: false, m: "Vous avez déjà un parrain (ou code utilisé)." };
                
                const cleanCode = code.trim().toUpperCase();

                // 1. Check CRYPTO10
                if (cleanCode === 'CRYPTO10') {
                    const updatedUser = { ...user, referredBy: SPECIAL_CODES.CRYPTO10 };
                    setUser(updatedUser);
                    updateUserInDb(updatedUser);
                    localStorage.setItem('xaluxa_user', JSON.stringify(updatedUser));
                    return { s: true, m: "Code Promo CRYPTO10 activé ! Parrainage désactivé." };
                }

                // 2. Check Standard Referral
                const referrer = allUsers.find(u => u.referralCode === cleanCode);
                
                if (!referrer) return { s: false, m: "Code parrain introuvable." };
                if (referrer.id === user.id) return { s: false, m: "Auto-parrainage interdit." };

                // Apply
                const updatedUser = { ...user, referredBy: referrer.id };
                setUser(updatedUser);
                updateUserInDb(updatedUser);
                localStorage.setItem('xaluxa_user', JSON.stringify(updatedUser));
                return { s: true, m: `Félicitations ! Vous êtes parrainé par ${referrer.discord.username}.` };
            };

            const claimReferralEarnings = () => {
                if (!user || user.referralWallet <= 0) return { s: false, m: "Rien à récupérer." };
                const amount = user.referralWallet;
                
                const updatedUser = {
                    ...user,
                    wallet: { ...user.wallet, cash: user.wallet.cash + amount },
                    referralWallet: 0
                };
                
                setUser(updatedUser);
                updateUserInDb(updatedUser);
                localStorage.setItem('xaluxa_user', JSON.stringify(updatedUser));
                return { s: true, m: `$${amount.toFixed(2)} transférés vers votre portefeuille principal.` };
            };

            const updateUserInDb = (updatedUserObj) => {
                setAllUsers(prev => prev.map(u => u.id === updatedUserObj.id ? updatedUserObj : u));
            };

            const linkSteam = async () => {
                setIsLoading(true);
                setTimeout(() => {
                    if (!user) { setIsLoading(false); return; }
                    const steamId = "76561198" + Math.floor(Math.random() * 100000000);
                    const steamData = {
                        id: steamId,
                        username: "SteamUser_" + Math.floor(Math.random() * 1000),
                        avatar: "https://avatars.akamai.steamstatic.com/fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb_full.jpg"
                    };
                    const updatedUser = { ...user, steam: steamData };
                    setUser(updatedUser);
                    localStorage.setItem('xaluxa_user', JSON.stringify(updatedUser));
                    updateUserInDb(updatedUser); // Sync DB
                    setIsLoading(false);
                }, 1500);
            };

            const loginWithSteam = async () => {
                setIsLoading(true);
                setTimeout(() => {
                   const steamId = "76561198" + Math.floor(Math.random() * 100000000);
                   const steamData = { id: steamId, username: "SteamUser_Demo", avatar: "https://avatars.akamai.steamstatic.com/fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb_full.jpg" };
                   handleUserLogin({
                       id: 'demo_' + steamId,
                       discord: { id: 'demo_discord', username: 'DemoUser', avatar: 'https://cdn.discordapp.com/embed/avatars/0.png' }, 
                       steam: steamData,
                       wallet: { cash: 5000, assets: { [CryptoSymbol.ATERIS]: 0, [CryptoSymbol.BALIEM]: 0, [CryptoSymbol.BASTRUM]: 0, [CryptoSymbol.UDC]: 0 } }
                   });
                   setActivePage('HOME');
                   setIsLoading(false);
                }, 1000);
            };

            const adminLogin = (u, p) => {
                if (u === 'test' && p === 'test') {
                    setIsAdmin(true);
                    return true;
                }
                return false;
            };

            useEffect(() => {
                const interval = setInterval(() => setMarket(m => simulateMarketUpdate(m)), 3000);
                return () => clearInterval(interval);
            }, []);

            const logout = () => { setUser(null); setActivePage('HOME'); localStorage.removeItem('xaluxa_user'); setIsAdmin(false); };
            
            const buyAsset = (s, amt) => {
                if(!user) return {s:false, m:'Connectez-vous'};
                const asset = market.find(a => a.symbol === s);
                if(user.wallet.cash < amt) return {s:false, m:'Fonds insuffisants'};
                const qty = (amt * 0.98) / asset.price;
                const newUser = {...user, wallet: {...user.wallet, cash: user.wallet.cash - amt, assets: {...user.wallet.assets, [s]: (user.wallet.assets[s]||0)+qty}}};
                setUser(newUser); 
                updateUserInDb(newUser);
                localStorage.setItem('xaluxa_user', JSON.stringify(newUser));
                setTransactions(prev => [{type: 'BUY', symbol: s, qty: qty, price: asset.price, time: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}, ...prev.slice(0, 19)]);
                return {s:true, m:`Acheté ${qty.toFixed(4)} ${s}`};
            };

            const sellAsset = (s, qty) => {
                if(!user) return {s:false, m:'Connectez-vous'};
                const asset = market.find(a => a.symbol === s);
                if((user.wallet.assets[s]||0) < qty) return {s:false, m:'Pas assez d\'actifs'};
                const val = (qty * asset.price) * 0.98;
                const newUser = {...user, wallet: {...user.wallet, cash: user.wallet.cash + val, assets: {...user.wallet.assets, [s]: user.wallet.assets[s]-qty}}};
                setUser(newUser); 
                updateUserInDb(newUser);
                localStorage.setItem('xaluxa_user', JSON.stringify(newUser));
                setTransactions(prev => [{type: 'SELL', symbol: s, qty: qty, price: asset.price, time: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}, ...prev.slice(0, 19)]);
                return {s:true, m:`Vendu ${qty.toFixed(4)} ${s}`};
            };

            const transferCash = (toId, amt) => {
                if (!user.steam) return {s:false, m:"Connexion Steam requise pour les virements."};
                if(user.wallet.cash < amt) return {s:false, m:'Fonds insuffisants'};
                
                // 1. Deduct from Sender
                const newUser = {...user, wallet: {...user.wallet, cash: user.wallet.cash - amt}};
                setUser(newUser); 
                // DB update handled at the end
                localStorage.setItem('xaluxa_user', JSON.stringify(newUser));
                
                // 2. Commission Logic (1% on withdrawal/transfer)
                // If user has a real referrer (not CRYPTO10, not null)
                if (user.referredBy && user.referredBy !== SPECIAL_CODES.CRYPTO10) {
                    const commission = amt * 0.01; // 1%
                    
                    // Update the Referrer in DB
                    setAllUsers(prev => prev.map(u => {
                        if (u.id === user.referredBy) {
                            return {
                                ...u,
                                referralWallet: (u.referralWallet || 0) + commission,
                                totalReferralEarnings: (u.totalReferralEarnings || 0) + commission
                            };
                        }
                        // Update current user in DB same time
                        if (u.id === user.id) return newUser;
                        return u;
                    }));
                } else {
                    // Just update current user in DB
                    updateUserInDb(newUser);
                }

                setTransactions(prev => [{type: 'TRANSFER', symbol: 'USD', qty: amt, price: 1, time: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}, ...prev.slice(0, 19)]);
                return {s:true, m:`Virement de $${amt} vers ${toId}`};
            };

            const getPortfolioValue = () => {
                if(!user) return 0;
                let val = user.wallet.cash;
                Object.entries(user.wallet.assets).forEach(([s, q]) => {
                    const a = market.find(m => m.symbol === s);
                    if(a) val += q * a.price;
                });
                return val;
            };

            return (
                <MarketContext.Provider value={{ market, user, transactions, allUsers, isLoading, activePage, theme, isAdmin, linkSteam, loginWithSteam, adminLogin, toggleTheme, setActivePage, logout, buyAsset, sellAsset, transferCash, getPortfolioValue, applyReferralCode, claimReferralEarnings }}>
                    {children}
                </MarketContext.Provider>
            );
        };
        const useMarket = () => useContext(MarketContext);

        // --- 6. COMMON COMPONENTS ---

        const Logo = ({ size = 'md' }) => (
            <div className="flex items-center gap-2 font-bold tracking-wider select-none cursor-pointer">
                <div className="relative flex items-center justify-center">
                    <Activity className={`text-gold-500 ${size === 'lg' ? 'w-10 h-10' : 'w-6 h-6'}`} />
                    <TrendingUp className={`absolute -top-1 -right-1 text-emerald-500 ${size === 'lg' ? 'w-6 h-6' : 'w-4 h-4'}`} />
                </div>
                <div className={`flex flex-col leading-none`}>
                    <span className={`${size==='sm'?'text-lg':'text-2xl'} dark:text-white text-dark-950 transition-theme`}>XALUXA</span>
                    <span className="text-[0.6rem] text-gold-500 tracking-[0.2em] uppercase">Agency</span>
                </div>
            </div>
        );

        const ThemeToggle = () => {
            const { theme, toggleTheme } = useMarket();
            return (
                <button onClick={toggleTheme} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-dark-800 transition-all text-gold-500 dark:text-gold-400">
                    {theme === 'dark' ? <Sun /> : <Moon />}
                </button>
            );
        };

        const NavBar = () => {
            const { setActivePage, user, theme } = useMarket();
            
            // --- FIX FOR GITHUB PAGES 404 ERROR ---
            const redirectUri = "https://kaliaz2.github.io/PourMonBae/";
            const discordLoginUrl = `https://discord.com/oauth2/authorize?client_id=1453040768380833946&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=identify`;

            return (
                <nav className="container mx-auto px-6 py-6 flex justify-between items-center relative z-20">
                    <div onClick={() => setActivePage(user ? 'DASHBOARD' : 'HOME')}><Logo /></div>
                    <div className="hidden md:flex items-center gap-8 text-sm font-bold uppercase tracking-wider dark:text-gray-400 text-gray-600 transition-theme">
                        <button onClick={() => setActivePage('HOME')} className="hover:text-gold-500 transition-colors">Accueil</button>
                        <button onClick={() => setActivePage('ABOUT')} className="hover:text-gold-500 transition-colors">À Propos</button>
                        <button onClick={() => setActivePage('FEATURES')} className="hover:text-gold-500 transition-colors">Fonctionnalités</button>
                        <button onClick={() => setActivePage('TRANSFER')} className="hover:text-gold-500 transition-colors flex items-center gap-1"><Send size={14}/> Virements</button>
                        <button onClick={() => setActivePage('REFERRAL')} className="hover:text-gold-500 transition-colors flex items-center gap-1"><Users size={14}/> Affiliation</button>
                    </div>
                    <div className="flex items-center gap-4">
                        <ThemeToggle />
                        {user ? (
                            <button onClick={() => setActivePage('DASHBOARD')} className="bg-gold-500 text-white px-4 py-2 rounded font-bold hover:bg-gold-600 transition-all shadow-lg shadow-gold-500/20">
                                Dashboard
                            </button>
                        ) : (
                            <a href={discordLoginUrl} 
                               className="bg-discord-blue text-white px-5 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-opacity-90 transition-all">
                                <i className="fa-brands fa-discord"></i><span>Connexion</span>
                            </a>
                        )}
                    </div>
                </nav>
            );
        };

        const ProfileModal = ({ isOpen, onClose }) => {
            const { user, getPortfolioValue, setActivePage } = useMarket();
            if (!isOpen || !user) return null;

            const netWorth = getPortfolioValue();
            
            // Pie Chart Data
            const data = Object.entries(user.wallet.assets)
                .map(([symbol, qty]) => ({ name: symbol, value: qty }))
                .filter(d => d.value > 0);
            
            const COLORS = ['#f59e0b', '#3b82f6', '#10b981', '#94a3b8'];
            const avatar = user.discord ? user.discord.avatar : (user.steamAvatar || 'https://cdn.discordapp.com/embed/avatars/0.png');
            const username = user.discord ? user.discord.username : (user.steamName || 'User');

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white dark:bg-dark-800 rounded-2xl p-6 w-full max-w-md shadow-2xl relative animate-slide-up border dark:border-dark-700 border-light-200 transition-theme" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-rose-500"><X /></button>
                        
                        <div className="flex flex-col items-center mb-6">
                            <img src={avatar} className="w-20 h-20 rounded-full border-4 border-gold-500 shadow-lg mb-3" />
                            <h2 className="text-2xl font-bold dark:text-white text-dark-900">{username}</h2>
                            <span className="text-xs text-gray-500 uppercase tracking-widest bg-gray-100 dark:bg-dark-900 px-2 py-1 rounded">Membre</span>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="p-4 rounded-xl bg-gray-50 dark:bg-dark-900 text-center">
                                <p className="text-xs text-gray-500 uppercase">Valeur Nette</p>
                                <p className="text-xl font-bold text-gold-500">${netWorth.toLocaleString(undefined, {maximumFractionDigits:0})}</p>
                            </div>
                            <div className="p-4 rounded-xl bg-gray-50 dark:bg-dark-900 text-center">
                                <p className="text-xs text-gray-500 uppercase">Cash Disponible</p>
                                <p className="text-xl font-bold text-emerald-500">${user.wallet.cash.toLocaleString(undefined, {maximumFractionDigits:0})}</p>
                            </div>
                        </div>

                         <div className="mb-6 flex gap-2">
                             <button onClick={() => { setActivePage('REFERRAL'); onClose(); }} className="flex-1 bg-gold-500 hover:bg-gold-600 text-white py-3 rounded-lg font-bold text-sm">
                                 <Users className="inline mr-2" size={16}/> Affiliation
                             </button>
                             <button onClick={() => { setActivePage('TRANSFER'); onClose(); }} className="flex-1 bg-gray-200 dark:bg-dark-700 hover:bg-gray-300 dark:hover:bg-dark-600 dark:text-white py-3 rounded-lg font-bold text-sm">
                                 <Send className="inline mr-2" size={16}/> Virements
                             </button>
                         </div>

                        {data.length > 0 ? (
                            <div className="h-40 w-full relative">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie data={data} innerRadius={30} outerRadius={60} paddingAngle={5} dataKey="value">
                                            {data.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                            ))}
                                        </Pie>
                                        <Tooltip />
                                    </PieChart>
                                </ResponsiveContainer>
                            </div>
                        ) : (
                            <p className="text-center text-gray-400 text-sm py-4">Aucun actif acheté pour le moment.</p>
                        )}
                        
                        {user.steam && (
                            <div className="mt-4 pt-4 border-t dark:border-dark-700 border-gray-200 text-center text-steam-blue text-sm">
                                <i className="fa-brands fa-steam"></i> Lié : {user.steam.username}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const DashboardNavBar = () => {
            const { user, getPortfolioValue, logout, setActivePage } = useMarket();
            const [showProfile, setShowProfile] = useState(false);
            const totalValue = getPortfolioValue();

            if (!user) return null;
            const avatar = user.discord ? user.discord.avatar : (user.steamAvatar || 'https://cdn.discordapp.com/embed/avatars/0.png');
            const username = user.discord ? user.discord.username : (user.steamName || 'User');

            return (
                <>
                <div className="sticky top-0 z-40 backdrop-blur-md dark:bg-dark-900/90 bg-white/90 border-b dark:border-gold-500/30 border-gray-200 transition-theme p-3">
                    <div className="container mx-auto flex flex-wrap justify-between items-center gap-4">
                        {/* Left: Profile */}
                        <div className="flex items-center gap-4 cursor-pointer hover:opacity-80 transition-opacity" onClick={() => setShowProfile(true)}>
                            <div className="relative">
                                <img src={avatar} alt="Avatar" className="w-10 h-10 rounded-full border-2 border-gold-500" />
                                <div className="absolute -bottom-1 -right-1 bg-green-500 w-3 h-3 rounded-full border-2 border-white dark:border-dark-900"></div>
                            </div>
                            <div className="hidden sm:block">
                                <div className="font-bold dark:text-white text-dark-900 text-sm">{username}</div>
                                <div className="text-xs text-emerald-500 font-mono">${totalValue.toLocaleString()}</div>
                            </div>
                        </div>

                         {/* Center: Explicit Navigation (Replaces Icons) */}
                         <div className="flex items-center gap-2 md:gap-6 font-bold text-xs md:text-sm uppercase tracking-wider dark:text-gray-300 text-gray-700">
                             <button onClick={() => setActivePage('HOME')} className="hidden sm:block hover:text-gold-500 transition-colors">Accueil</button>
                             
                             {/* ALWAYS VISIBLE AFFILIATION BUTTON */}
                             <button onClick={() => setActivePage('REFERRAL')} className="bg-gold-500 hover:bg-gold-600 text-white px-3 py-1.5 md:px-4 md:py-2 rounded shadow-lg flex items-center gap-2 transition-transform hover:scale-105">
                                <Users size={16}/> <span>Affiliation</span>
                             </button>
                             
                             <button onClick={() => setActivePage('TRANSFER')} className="hover:text-gold-500 transition-colors flex items-center gap-2">
                                <Send size={16}/> <span className="hidden sm:inline">Virements</span>
                             </button>
                         </div>

                        {/* Right: Actions */}
                        <div className="flex items-center gap-2">
                            <ThemeToggle />
                            <button onClick={logout} className="p-2 rounded-lg bg-rose-500/10 text-rose-500 hover:bg-rose-500/20 transition-colors" title="Déconnexion">
                                <LogOut size={18} />
                            </button>
                        </div>
                    </div>
                </div>
                <ProfileModal isOpen={showProfile} onClose={() => setShowProfile(false)} />
                </>
            );
        };

        // --- 7. CHARTS & PANELS ---

        const AssetChart = ({ asset }) => {
            const data = asset.history.map((h, i) => ({ name: h.time, price: h.price }));
            const color = asset.change24h >= 0 ? '#10b981' : '#f43f5e';
            return (
                <div className="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-xl border dark:border-dark-700 border-light-200 h-96 flex flex-col transition-theme">
                    <div className="flex justify-between items-end mb-4">
                        <div>
                            <h3 className="text-2xl font-bold dark:text-white text-dark-900">{asset.name}</h3>
                            <span className="text-sm text-gray-500">{asset.symbol}/USD</span>
                        </div>
                        <div className={`text-right ${asset.change24h >=0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                            <div className="text-2xl font-mono font-bold">${asset.price.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
                            <div className="text-sm font-bold">{asset.change24h>0?'+':''}{asset.change24h.toFixed(2)}%</div>
                        </div>
                    </div>
                    <ResponsiveContainer width="100%" height="100%">
                        <AreaChart data={data}>
                            <defs><linearGradient id={`c${asset.symbol}`} x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={color} stopOpacity={0.2}/><stop offset="95%" stopColor={color} stopOpacity={0}/></linearGradient></defs>
                            <CartesianGrid strokeDasharray="3 3" opacity={0.1} />
                            <Tooltip contentStyle={{backgroundColor:'#1e293b', border:'none', color:'#fff'}} />
                            <Area type="monotone" dataKey="price" stroke={color} fill={`url(#c${asset.symbol})`} strokeWidth={3} />
                        </AreaChart>
                    </ResponsiveContainer>
                </div>
            );
        };

        const TradePanel = ({ asset }) => {
            const { buyAsset, sellAsset, user } = useMarket();
            const [amt, setAmt] = useState('');
            const [msg, setMsg] = useState(null);

            const exec = (type) => {
                if(!user) return setMsg({t:'err', m:'Non connecté'});
                const val = parseFloat(amt);
                if(isNaN(val) || val <= 0) return setMsg({t:'err', m:'Montant invalide'});
                const res = type === 'BUY' ? buyAsset(asset.symbol, val) : sellAsset(asset.symbol, val);
                setMsg({t: res.s?'suc':'err', m: res.m});
                if(res.s) setAmt('');
                setTimeout(() => setMsg(null), 3000);
            };

            return (
                <div className="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-xl border dark:border-dark-700 border-light-200 h-full flex flex-col transition-theme">
                    <h3 className="text-lg font-bold dark:text-gray-200 text-gray-700 mb-4 uppercase tracking-wide">Passer un ordre</h3>
                    <div className="flex-1 flex flex-col gap-4">
                        <input type="number" placeholder="Montant / Quantité" className="w-full bg-gray-100 dark:bg-dark-900 p-4 rounded-lg outline-none focus:ring-2 ring-gold-500 dark:text-white transition-all" value={amt} onChange={e => setAmt(e.target.value)} />
                        <div className="grid grid-cols-2 gap-3 mt-auto">
                            <button onClick={() => exec('BUY')} className="bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-lg font-bold transition-all">ACHETER</button>
                            <button onClick={() => exec('SELL')} className="bg-rose-500 hover:bg-rose-600 text-white py-3 rounded-lg font-bold transition-all">VENDRE</button>
                        </div>
                        {msg && <div className={`p-2 rounded text-center text-sm ${msg.t==='suc'?'bg-emerald-100 text-emerald-700':'bg-rose-100 text-rose-700'}`}>{msg.m}</div>}
                    </div>
                </div>
            );
        };

        const TransactionHistory = () => {
            const { transactions } = useMarket();
            return (
                <div className="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-xl border dark:border-dark-700 border-light-200 h-80 flex flex-col transition-theme">
                    <div className="flex items-center gap-2 mb-4">
                        <Clock className="text-gray-400" size={20} />
                        <h3 className="text-lg font-bold dark:text-gray-200 text-gray-700 uppercase tracking-wide">Historique</h3>
                    </div>
                    <div className="flex-1 overflow-y-auto space-y-3 pr-2">
                        {transactions.length === 0 ? (
                            <div className="text-center text-gray-500 text-sm mt-10">Aucune transaction récente</div>
                        ) : (
                            transactions.map((t, i) => (
                                <div key={i} className="flex justify-between items-center p-3 rounded-lg bg-gray-50 dark:bg-dark-900 hover:bg-gray-100 dark:hover:bg-dark-700 transition-colors">
                                    <div className="flex flex-col">
                                        <div className="flex items-center gap-2">
                                            <span className={`text-xs font-bold px-2 py-0.5 rounded ${t.type === 'BUY' ? 'bg-emerald-100 text-emerald-600' : t.type === 'SELL' ? 'bg-rose-100 text-rose-600' : 'bg-blue-100 text-blue-600'}`}>{t.type}</span>
                                            <span className="font-bold dark:text-white text-dark-900">{t.symbol}</span>
                                        </div>
                                        <span className="text-xs text-gray-500">{t.time}</span>
                                    </div>
                                    <div className="text-right">
                                        <div className="font-mono text-sm dark:text-gray-300 text-gray-700">{typeof t.qty === 'number' ? t.qty.toFixed(4) : t.qty}</div>
                                        <div className="text-xs text-gray-500">@ ${t.price.toLocaleString()}</div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const NewsFeed = () => {
            const news = [
                { title: "Régulation des Crypto en approche", time: "2m", tag: "INFO" },
                { title: "BASTRUM signe un partenariat géant", time: "15m", tag: "PUMP" },
                { title: "L'inflation US inquiète les marchés", time: "1h", tag: "MACRO" },
                { title: "ATERIS lance son nouveau Mainnet", time: "3h", tag: "TECH" },
            ];
            return (
                <div className="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-xl border dark:border-dark-700 border-light-200 h-80 flex flex-col transition-theme">
                    <div className="flex items-center gap-2 mb-4">
                        <Newspaper className="text-gold-500" size={20} />
                        <h3 className="text-lg font-bold dark:text-gray-200 text-gray-700 uppercase tracking-wide">Flash Infos</h3>
                    </div>
                    <div className="flex-1 overflow-y-auto space-y-4">
                        {news.map((n, i) => (
                            <div key={i} className="border-b dark:border-dark-700 border-light-300 pb-3 last:border-0">
                                <div className="flex justify-between items-start mb-1">
                                    <span className="text-[10px] font-bold bg-gray-200 dark:bg-dark-700 px-2 py-0.5 rounded text-gray-600 dark:text-gray-300">{n.tag}</span>
                                    <span className="text-xs text-gray-400">{n.time}</span>
                                </div>
                                <h4 className="text-sm font-semibold dark:text-gray-200 text-dark-900 leading-tight hover:text-gold-500 cursor-pointer transition-colors">{n.title}</h4>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const LeaderboardWidget = () => {
            const ranks = [
                { n: 'CryptoKing', v: '$145k', c: 'text-gold-500' },
                { n: 'Satoshi_Fan', v: '$132k', c: 'text-gray-400' },
                { n: 'BullRun2025', v: '$110k', c: 'text-amber-700' },
            ];
            return (
                <div className="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-xl border dark:border-dark-700 border-light-200 h-80 flex flex-col transition-theme">
                    <div className="flex items-center gap-2 mb-4">
                        <Trophy className="text-purple-500" size={20} />
                        <h3 className="text-lg font-bold dark:text-gray-200 text-gray-700 uppercase tracking-wide">Top Traders</h3>
                    </div>
                    <div className="space-y-3">
                        {ranks.map((r, i) => (
                            <div key={i} className="flex items-center justify-between p-2 rounded hover:bg-gray-50 dark:hover:bg-dark-900 transition-colors">
                                <div className="flex items-center gap-3">
                                    <span className={`font-mono font-bold w-4 text-center ${i<3 ? r.c : 'text-gray-500'}`}>{i+1}</span>
                                    <span className="text-sm font-medium dark:text-gray-300 text-gray-700">{r.n}</span>
                                </div>
                                <span className="text-sm font-bold text-emerald-500">{r.v}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 8. PAGES ---

        const Dashboard = () => {
            const { market, user, setActivePage } = useMarket();
            const [sel, setSel] = useState('ATERIS');
            const asset = market.find(m => m.symbol === sel) || market[0];

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-dark-950 transition-theme pb-20 relative">
                    <DashboardNavBar />
                    <div className="container mx-auto p-4 md:p-6 space-y-6">
                        {/* Top Row: Asset Tickers */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            {market.map(m => (
                                <button key={m.symbol} onClick={() => setSel(m.symbol)} className={`p-4 rounded-xl border text-left transition-all ${sel === m.symbol ? 'border-gold-500 bg-white dark:bg-dark-800 shadow-lg ring-1 ring-gold-500' : 'border-transparent bg-white dark:bg-dark-900 hover:bg-gray-50 dark:hover:bg-dark-800'}`}>
                                    <div className="font-bold text-gray-500 text-xs mb-1">{m.name}</div>
                                    <div className="font-mono font-bold dark:text-white text-dark-900">${m.price.toLocaleString(undefined,{maximumFractionDigits:2})}</div>
                                    <div className={`text-xs font-bold ${m.change24h>=0?'text-emerald-500':'text-rose-500'}`}>{m.change24h>0?'+':''}{m.change24h.toFixed(2)}%</div>
                                </button>
                            ))}
                        </div>

                         {/* NEW: Referral Banner (Re-applied) */}
                        <div className="bg-gradient-to-r from-gold-600 to-amber-600 rounded-xl p-6 shadow-lg text-white relative overflow-hidden flex flex-col md:flex-row items-center justify-between gap-4">
                             <div className="flex items-center gap-4 relative z-10">
                                <div className="bg-white/20 p-3 rounded-full"><Users size={24} /></div>
                                <div>
                                    <h3 className="font-bold text-xl">Programme Partenaire</h3>
                                    <p className="text-gold-100 text-sm">Invitez vos amis et gagnez 1% de commission à vie.</p>
                                </div>
                             </div>
                             <button onClick={() => setActivePage('REFERRAL')} className="relative z-10 bg-white text-gold-600 px-6 py-2 rounded-lg font-bold hover:bg-gold-50 transition-colors shadow-md whitespace-nowrap">
                                Accéder à l'Affiliation
                             </button>
                             <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                        </div>

                        {/* Middle Row: Chart & Trade */}
                        <div className="grid lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2"><AssetChart asset={asset} /></div>
                            <div><TradePanel asset={asset} /></div>
                        </div>

                        {/* Bottom Row: Widgets */}
                        <div className="grid lg:grid-cols-3 gap-6 animate-slide-up">
                            <LeaderboardWidget />
                            <TransactionHistory />
                            <NewsFeed />
                        </div>
                    </div>
                    {/* Floating Action Button Failsafe */}
                    <button onClick={() => setActivePage('REFERRAL')} className="fixed bottom-6 right-6 bg-gold-500 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center z-50 hover:scale-110 transition-transform md:hidden">
                        <Users size={24} />
                    </button>
                </div>
            );
        };

        const ReferralPage = () => {
            const { user, applyReferralCode, claimReferralEarnings, allUsers } = useMarket();
            const [code, setCode] = useState('');
            const [msg, setMsg] = useState(null);

            if (!user) return <div className="min-h-screen flex items-center justify-center dark:text-white text-dark-900">Veuillez vous connecter.</div>;

            // Stats calculation
            const myAffiliates = allUsers.filter(u => u.referredBy === user.id);
            const totalAffiliates = myAffiliates.length;
            const referralLink = `${window.location.origin}/PourMonBae?ref=${user.referralCode}`; // Mock link logic
            
            const handleApply = () => {
                if(!code) return;
                const res = applyReferralCode(code);
                setMsg(res);
                if(res.s) setCode('');
            };

            const handleClaim = () => {
                const res = claimReferralEarnings();
                setMsg(res);
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(user.referralCode);
                setMsg({s:true, m:"Code copié !"});
                setTimeout(() => setMsg(null), 2000);
            }

            return (
                <div className="min-h-screen dark:bg-dark-950 bg-gray-50 transition-theme pt-20">
                    <NavBar />
                    <div className="container mx-auto px-6 py-12">
                        <div className="mb-10 text-center">
                            <h1 className="text-4xl font-bold dark:text-white text-dark-900 mb-2">Programme d'Affiliation</h1>
                            <p className="text-gray-500">Gagnez 1% sur chaque retrait effectué par vos filleuls, à vie.</p>
                        </div>

                        <div className="grid lg:grid-cols-2 gap-8 max-w-6xl mx-auto">
                            {/* LEFT: MY STATS */}
                            <div className="space-y-6">
                                <div className="bg-gradient-to-br from-gold-500 to-amber-600 rounded-2xl p-8 text-white shadow-2xl relative overflow-hidden">
                                    <div className="relative z-10">
                                        <div className="text-gold-100 uppercase text-xs font-bold tracking-widest mb-1">Cagnotte Parrainage</div>
                                        <div className="text-5xl font-black mb-6">${(user.referralWallet || 0).toFixed(2)}</div>
                                        <button onClick={handleClaim} className="bg-white text-gold-600 px-6 py-3 rounded-xl font-bold hover:bg-gold-50 transition-colors shadow-lg disabled:opacity-50" disabled={(user.referralWallet || 0) <= 0}>
                                            Récupérer mes gains
                                        </button>
                                    </div>
                                    <Coins className="absolute -right-6 -bottom-6 text-gold-400 opacity-30 w-48 h-48" />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white dark:bg-dark-800 p-6 rounded-xl border dark:border-dark-700 shadow-lg">
                                        <div className="text-gray-500 text-xs uppercase font-bold mb-2">Filleuls Total</div>
                                        <div className="text-3xl font-bold dark:text-white">{totalAffiliates}</div>
                                    </div>
                                    <div className="bg-white dark:bg-dark-800 p-6 rounded-xl border dark:border-dark-700 shadow-lg">
                                        <div className="text-gray-500 text-xs uppercase font-bold mb-2">Gains à vie</div>
                                        <div className="text-3xl font-bold text-emerald-500">${(user.totalReferralEarnings || 0).toFixed(2)}</div>
                                    </div>
                                </div>

                                <div className="bg-white dark:bg-dark-800 p-8 rounded-2xl border dark:border-dark-700 shadow-xl">
                                    <h3 className="text-lg font-bold dark:text-white mb-4">Votre Code Parrain</h3>
                                    <div className="flex gap-4">
                                        <div className="flex-1 bg-gray-100 dark:bg-dark-900 p-4 rounded-xl font-mono text-xl text-center tracking-widest font-bold dark:text-gold-400 border border-dashed border-gray-400 dark:border-dark-600 select-all">
                                            {user.referralCode}
                                        </div>
                                        <button onClick={copyToClipboard} className="bg-gray-200 dark:bg-dark-700 p-4 rounded-xl hover:bg-gray-300 dark:hover:bg-dark-600 transition-colors">
                                            <LinkIcon />
                                        </button>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-3 text-center">Partagez ce code unique. Il ne changera jamais.</p>
                                </div>
                            </div>

                            {/* RIGHT: ENTER CODE */}
                            <div className="space-y-6">
                                <div className="bg-white dark:bg-dark-800 p-8 rounded-2xl border dark:border-dark-700 shadow-xl h-full flex flex-col justify-center">
                                    <h3 className="text-2xl font-bold dark:text-white mb-6">Êtes-vous parrainé ?</h3>
                                    
                                    {user.referredBy ? (
                                        <div className="text-center py-10 animate-fade-in">
                                            <div className="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-500">
                                                <CheckCircle size={40} />
                                            </div>
                                            <h4 className="text-xl font-bold text-emerald-500 mb-2">Code Actif</h4>
                                            <p className="text-gray-500">
                                                {user.referredBy === 'SYSTEM_CRYPTO10' 
                                                    ? "Vous bénéficiez du statut CRYPTO10." 
                                                    : `Parrainé par l'utilisateur ID: ${user.referredBy.substring(0,8)}...`}
                                            </p>
                                            <div className="mt-6 text-xs text-gray-400 uppercase tracking-widest border-t dark:border-dark-700 pt-4">Lien définitif</div>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <p className="text-gray-500 mb-4">Entrez un code de parrainage pour lier votre compte. <span className="text-rose-500 font-bold">Attention : cette action est irréversible.</span></p>
                                            <input 
                                                type="text" 
                                                placeholder="Entrez le code ici (ex: KALI1234)" 
                                                className="w-full bg-gray-100 dark:bg-dark-900 p-5 rounded-xl outline-none focus:ring-2 ring-gold-500 dark:text-white text-lg font-bold text-center uppercase"
                                                value={code}
                                                onChange={e => setCode(e.target.value)}
                                            />
                                            <button onClick={handleApply} className="w-full bg-dark-900 hover:bg-black text-white py-4 rounded-xl font-bold text-lg shadow-lg transition-all border border-gray-700">
                                                Valider le code
                                            </button>
                                            <div className="text-xs text-center text-gray-400 mt-4">
                                                Code système accepté : <span className="font-mono text-gold-500">CRYPTO10</span>
                                            </div>
                                        </div>
                                    )}

                                    {msg && (
                                        <div className={`mt-6 p-4 rounded-xl text-center font-bold animate-fade-in ${msg.s ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>
                                            {msg.m}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TransferPage = () => {
            const { user, linkSteam, transferCash, isLoading } = useMarket();
            const [dest, setDest] = useState('');
            const [amount, setAmount] = useState('');
            const [msg, setMsg] = useState(null);

            // --- CHANGE 2: UPDATE AUTH MESSAGE ---
            if (!user) return (
                <div className="min-h-screen flex items-center justify-center dark:bg-dark-950 bg-gray-50 flex-col gap-4">
                    <p className="text-xl font-bold dark:text-white">Connexion avec Steam.</p>
                </div>
            );

            const hasSteam = !!user.steam;

            const handleTransfer = (e) => {
                e.preventDefault();
                const val = parseFloat(amount);
                if(!dest || isNaN(val)) return;
                const res = transferCash(dest, val);
                setMsg(res);
                if(res.s) { setAmount(''); setDest(''); }
            };

            return (
                <div className="min-h-screen dark:bg-dark-950 bg-gray-50 transition-theme pt-20">
                    <NavBar />
                    <div className="container mx-auto px-6 py-12 flex justify-center">
                        <div className="w-full max-w-lg bg-white dark:bg-dark-800 rounded-2xl p-8 shadow-2xl border dark:border-dark-700 border-light-200">
                            <h1 className="text-3xl font-bold mb-6 flex items-center gap-3 dark:text-white text-dark-900">
                                <Send className="text-gold-500" /> Virement Sécurisé
                            </h1>

                            {!hasSteam ? (
                                <div className="text-center py-8 space-y-6">
                                    <div className="bg-rose-500/10 text-rose-500 p-4 rounded-xl border border-rose-500/20 flex items-center gap-3">
                                        <ShieldAlert size={32} />
                                        <div className="text-left text-sm">
                                            <strong className="block text-lg">Sécurité Requise</strong>
                                            Identité Steam requise pour virer des fonds.
                                        </div>
                                    </div>
                                    <button onClick={linkSteam} disabled={isLoading} className="w-full bg-[#171a21] hover:bg-[#2a475e] text-white py-4 rounded-xl font-bold flex items-center justify-center gap-3 shadow-lg transition-all">
                                        {isLoading ? <i className="fa-solid fa-spinner fa-spin"></i> : <SteamIcon />}
                                        Lier mon compte Steam
                                    </button>
                                </div>
                            ) : (
                                <form onSubmit={handleTransfer} className="space-y-6">
                                    <div className="flex items-center gap-4 bg-emerald-500/10 p-4 rounded-xl border border-emerald-500/20">
                                        <img src={user.steam.avatar} className="w-12 h-12 rounded-full border-2 border-emerald-500" />
                                        <div>
                                            <div className="text-sm text-gray-500">Compte Source</div>
                                            <div className="font-bold dark:text-white">{user.steam.username}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-500 mb-2">ID Destinataire</label>
                                        <input type="text" value={dest} onChange={e => setDest(e.target.value)} className="w-full bg-gray-100 dark:bg-dark-900 p-4 rounded-lg outline-none focus:ring-2 ring-gold-500 dark:text-white" placeholder="Ex: 7656..." />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-500 mb-2">Montant ($)</label>
                                        <input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="w-full bg-gray-100 dark:bg-dark-900 p-4 rounded-lg outline-none focus:ring-2 ring-gold-500 dark:text-white" placeholder="0.00" />
                                        <p className="text-xs text-gray-400 mt-2 italic">* Frais de réseau (1%) appliqués pour le parrain.</p>
                                    </div>
                                    <button type="submit" className="w-full bg-gold-500 hover:bg-gold-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg">Confirmer</button>
                                    {msg && (
                                        <div className={`p-4 rounded-xl text-center font-bold ${msg.s ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>
                                            {msg.m}
                                        </div>
                                    )}
                                </form>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const AdminLogin = () => {
            const { adminLogin, setActivePage } = useMarket();
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [err, setErr] = useState(false);

            const sub = (e) => {
                e.preventDefault();
                if(adminLogin(u, p)) setActivePage('ADMIN_DASHBOARD');
                else setErr(true);
            };

            return (
                <div className="min-h-screen bg-dark-950 flex items-center justify-center p-4">
                    <div className="w-full max-w-md bg-dark-800 p-8 rounded-2xl border border-dark-700 shadow-2xl">
                        <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2"><Lock className="text-rose-500"/> Administration</h2>
                        <form onSubmit={sub} className="space-y-4">
                            <input type="text" placeholder="Pseudo" className="w-full bg-dark-900 p-3 rounded text-white border border-dark-700" value={u} onChange={e=>setU(e.target.value)} />
                            <input type="password" placeholder="Mot de passe" className="w-full bg-dark-900 p-3 rounded text-white border border-dark-700" value={p} onChange={e=>setP(e.target.value)} />
                            {err && <p className="text-rose-500 text-sm">Erreur d'identifiants.</p>}
                            <button className="w-full bg-rose-600 hover:bg-rose-700 text-white py-3 rounded font-bold">Connexion</button>
                        </form>
                        <button onClick={() => setActivePage('HOME')} className="mt-4 text-gray-500 text-sm hover:text-white w-full">Retour site</button>
                    </div>
                </div>
            );
        };

        const AdminDashboard = () => {
            const { isAdmin, allUsers, setActivePage } = useMarket();
            
            if(!isAdmin) {
                setTimeout(() => setActivePage('ADMIN_LOGIN'), 0);
                return null;
            }

            return (
                <div className="min-h-screen bg-gray-100 dark:bg-dark-950 transition-theme p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-3xl font-bold dark:text-white text-dark-900">Panel Administrateur</h1>
                            <button onClick={() => setActivePage('HOME')} className="bg-dark-800 text-white px-4 py-2 rounded hover:bg-dark-700">Quitter</button>
                        </div>

                        <div className="bg-white dark:bg-dark-800 rounded-xl shadow-xl overflow-hidden border dark:border-dark-700 border-gray-200">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm text-gray-500 dark:text-gray-400">
                                    <thead className="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-dark-900 dark:text-gray-400">
                                        <tr>
                                            <th className="px-6 py-3">User</th>
                                            <th className="px-6 py-3">Referral</th>
                                            <th className="px-6 py-3">Earnings</th>
                                            <th className="px-6 py-3">Dates</th>
                                            <th className="px-6 py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {allUsers.map((u, i) => (
                                            <tr key={i} className="border-b dark:border-dark-700 bg-white dark:bg-dark-800 hover:bg-gray-50 dark:hover:bg-dark-700">
                                                <td className="px-6 py-4 flex items-center gap-3">
                                                    <img src={u.discord.avatar} className="w-8 h-8 rounded-full" />
                                                    <div className="font-bold dark:text-white">{u.discord.username}</div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div className="text-xs">Code: <span className="font-mono text-gold-500">{u.referralCode}</span></div>
                                                    <div className="text-xs">By: {u.referredBy || 'None'}</div>
                                                </td>
                                                <td className="px-6 py-4 font-mono text-xs text-emerald-500 font-bold">
                                                    ${(u.totalReferralEarnings || 0).toFixed(2)}
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div>Inscrit: {new Date(u.joinedAt).toLocaleDateString()}</div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div className="flex gap-2">
                                                        <button className="text-rose-500 border border-rose-500/30 px-2 py-1 rounded text-xs">Ban</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Home = () => {
            const { loginWithSteam, isLoading, setActivePage, user } = useMarket();
            
            // --- FIX FOR GITHUB PAGES 404 ERROR ---
            const redirectUri = "https://kaliaz2.github.io/PourMonBae/";
            const discordLoginUrl = `https://discord.com/oauth2/authorize?client_id=1453040768380833946&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=identify`;
            
            return (
                <div className="min-h-screen bg-gray-50 dark:bg-dark-950 transition-theme flex flex-col relative">
                    <NavBar />
                    
                    {/* Hero */}
                    <header className="container mx-auto px-6 py-20 flex flex-col lg:flex-row items-center gap-12">
                        <div className="lg:w-1/2 space-y-6">
                            <span className="text-gold-500 font-bold tracking-widest uppercase text-sm bg-gold-500/10 px-3 py-1 rounded-full">Simulation V2.0</span>
                            <h1 className="text-5xl lg:text-7xl font-black dark:text-white text-dark-900 leading-tight">
                                Le Trading <br /><span className="text-gold-500">Sans Risque.</span>
                            </h1>
                            <p className="text-lg text-gray-500 dark:text-gray-400 max-w-lg">
                                Apprenez, expérimentez et maîtrisez les marchés crypto volatils avec 0$ de risque. Rejoignez l'élite des traders virtuels.
                            </p>
                            <div className="flex gap-4 pt-4">
                                {user ? (
                                    <button onClick={() => setActivePage('DASHBOARD')} className="bg-gradient-to-r from-gold-600 to-gold-400 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-xl hover:scale-105 transition-transform flex items-center gap-3">
                                        <Activity /> Accéder au Dashboard
                                    </button>
                                ) : (
                                    <>
                                    {/* --- CHANGE 3: BUTTON TEXT "STEAM" INSTEAD OF "DEMO STEAM" --- */}
                                    <button onClick={loginWithSteam} disabled={isLoading} className="bg-dark-900 text-white px-6 py-4 rounded-xl font-bold flex items-center gap-3 hover:bg-dark-800 transition-colors shadow-lg border border-gray-700">
                                        {isLoading ? <i className="fa-solid fa-spinner fa-spin"></i> : <i className="fa-brands fa-steam text-xl"></i>} Mode Test / Local
                                    </button>
                                    <a href={discordLoginUrl} className="bg-discord-blue text-white px-6 py-4 rounded-xl font-bold flex items-center gap-3 hover:opacity-90 transition-colors shadow-lg">
                                        {isLoading ? <i className="fa-solid fa-spinner fa-spin"></i> : <i className="fa-brands fa-discord text-xl"></i>} Discord
                                    </a>
                                    </>
                                )}
                                <button onClick={() => setActivePage('REFERRAL')} className="bg-dark-900 text-white px-6 py-4 rounded-xl font-bold flex items-center gap-3 hover:bg-dark-800 transition-colors shadow-lg border border-gray-700">
                                    <Users /> Affiliation
                                </button>
                            </div>
                        </div>
                        <div className="lg:w-1/2 relative animate-slide-up">
                            <div className="absolute inset-0 bg-gradient-to-r from-gold-500 to-purple-600 rounded-full blur-[100px] opacity-20"></div>
                            <img src="https://images.unsplash.com/photo-1642790106117-e829e14a795f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" className="relative z-10 rounded-3xl shadow-2xl border-4 dark:border-dark-800 border-white transform rotate-2 hover:rotate-0 transition-all duration-500" alt="Trading Dashboard" />
                        </div>
                    </header>

                    {/* How It Works */}
                    <section className="py-20 bg-white dark:bg-dark-900 transition-theme">
                        <div className="container mx-auto px-6">
                            <h2 className="text-3xl font-bold text-center mb-16 dark:text-white text-dark-900">Comment ça marche ?</h2>
                            <div className="grid md:grid-cols-3 gap-10">
                                {[
                                    {icon: <Briefcase />, title: "1. Connectez-vous", desc: "Utilisez votre compte Discord pour créer votre portefeuille."},
                                    {icon: <Activity />, title: "2. Analysez", desc: "Suivez les courbes en temps réel des actifs fictifs."},
                                    {icon: <Trophy />, title: "3. Dominez", desc: "Achetez bas, vendez haut et grimpez dans le classement mondial."}
                                ].map((step, i) => (
                                    <div key={i} className="text-center group">
                                        <div className="w-20 h-20 mx-auto bg-gray-100 dark:bg-dark-800 rounded-2xl flex items-center justify-center text-gold-500 text-3xl mb-6 group-hover:scale-110 transition-transform shadow-lg">{step.icon}</div>
                                        <h3 className="text-xl font-bold mb-3 dark:text-white text-dark-900">{step.title}</h3>
                                        <p className="text-gray-500 text-sm leading-relaxed">{step.desc}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </section>
                    
                    <footer className="mt-auto py-6 bg-dark-900 text-center relative z-10 border-t border-dark-800">
                        <button onClick={() => setActivePage('ADMIN_LOGIN')} className="text-xs text-dark-700 hover:text-rose-500 transition-colors">Admin Access</button>
                        <div className="text-gray-600 text-xs mt-2">&copy; 2025 XALUXA AGENCY.</div>
                    </footer>
                </div>
            );
        };

        const Features = () => {
            const { setActivePage } = useMarket();
            return (
                <div className="min-h-screen bg-gray-50 dark:bg-dark-950 transition-theme pt-20">
                    <NavBar />
                    <div className="container mx-auto px-6 py-12">
                        <div className="text-center mb-16">
                            <h1 className="text-4xl font-bold dark:text-white text-dark-900 mb-4">Fonctionnalités Avancées</h1>
                            <p className="text-gray-500">Tout ce dont vous avez besoin pour devenir un expert.</p>
                        </div>
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                            {[
                                {color: 'text-gold-500', icon: <TrendingUp />, t: "Temps Réel", d: "Moteur de marché réactif avec latence nulle."},
                                {color: 'text-emerald-500', icon: <Layers />, t: "Multi-Actifs", d: "Diversifiez votre portefeuille avec 4 cryptos uniques."},
                                {color: 'text-blue-500', icon: <Trophy />, t: "Compétition", d: "Classement mondial mis à jour en direct."},
                                {color: 'text-purple-500', icon: <Coins />, t: "Économie", d: "Système de frais de transaction réaliste (2%)."},
                                {color: 'text-rose-500', icon: <Activity />, t: "Volatilité", d: "Événements de marché aléatoires (Krach, Pump)."},
                                {color: 'text-indigo-500', icon: <Briefcase />, t: "Portefeuille", d: "Suivi précis des profits et pertes (PnL)."}
                            ].map((f, i) => (
                                <div key={i} className="bg-white dark:bg-dark-800 p-8 rounded-2xl shadow-lg border dark:border-dark-700 border-gray-100 hover:-translate-y-2 transition-transform">
                                    <div className={`${f.color} mb-4`}>{React.cloneElement(f.icon, {size: 40})}</div>
                                    <h3 className="text-xl font-bold dark:text-white text-dark-900 mb-2">{f.t}</h3>
                                    <p className="text-gray-500 text-sm">{f.d}</p>
                                </div>
                            ))}
                        </div>
                        <div className="text-center mt-12">
                            <button onClick={() => setActivePage('HOME')} className="text-gold-500 font-bold hover:underline">Retour à l'accueil</button>
                        </div>
                    </div>
                </div>
            );
        };

        const About = () => {
            const { setActivePage } = useMarket();
            return (
                <div className="min-h-screen bg-gray-50 dark:bg-dark-950 transition-theme pt-20">
                    <NavBar />
                    <div className="container mx-auto px-6 py-12 text-center max-w-3xl">
                        <h1 className="text-4xl font-bold text-gold-500 mb-8">L'histoire de XALUXA</h1>
                        <div className="bg-white dark:bg-dark-800 p-10 rounded-3xl shadow-xl text-left space-y-6 dark:text-gray-300 text-gray-600 leading-relaxed border dark:border-dark-700 border-gray-100">
                            <p>Née de la frustration des plateformes de trading trop complexes, <strong className="text-gold-500">XALUXA AGENCY</strong> a été créée en 2025 pour offrir un terrain de jeu sûr.</p>
                            <p>Notre mission est simple : permettre à n'importe qui, n'importe où, de comprendre les mécanismes financiers sans risquer un seul centime réel.</p>
                            <div className="flex justify-center pt-8 gap-6">
                                <a href="#" className="text-gray-400 hover:text-discord-blue text-3xl transition-colors"><i className="fa-brands fa-discord"></i></a>
                                <a href="#" className="text-gray-400 hover:text-black dark:hover:text-white text-3xl transition-colors"><i className="fa-brands fa-github"></i></a>
                                <a href="#" className="text-gray-400 hover:text-blue-400 text-3xl transition-colors"><i className="fa-brands fa-twitter"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- 9. ROOT ---
        const App = () => {
            const { activePage } = useMarket();
            switch(activePage) {
                case 'DASHBOARD': return <Dashboard />;
                case 'ABOUT': return <About />;
                case 'FEATURES': return <Features />;
                case 'TRANSFER': return <TransferPage />;
                case 'REFERRAL': return <ReferralPage />;
                case 'ADMIN_LOGIN': return <AdminLogin />;
                case 'ADMIN_DASHBOARD': return <AdminDashboard />;
                default: return <Home />;
            }
        };

        const Root = () => (
            <MarketProvider>
                <App />
            </MarketProvider>
        );

        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>